{% extends "base.html" %}

{% block title %}{{ 'Editar' if fornecedor else 'Novo' }} Fornecedor - MeetCall System{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            {% if fornecedor %}Editar Fornecedor{% else %}Novo Fornecedor{% endif %}
        </h1>
        <p class="text-gray-600 mt-1">Preencha os dados do fornecedor</p>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="POST" id="fornecedorForm">
            <!-- Campo hidden para contatos JSON -->
            <input type="hidden" name="contatos_json" id="contatos_json" value="[]">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tipo Pessoa -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo <span class="text-red-500">*</span>
                    </label>
                    <select name="tipo_pessoa" id="tipo_pessoa" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                        <option value="juridica" {% if not fornecedor or fornecedor.tipo_pessoa == 'juridica' %}selected{% endif %}>Pessoa Jurídica (CNPJ)</option>
                        <option value="fisica" {% if fornecedor and fornecedor.tipo_pessoa == 'fisica' %}selected{% endif %}>Pessoa Física (CPF)</option>
                    </select>
                </div>

                <!-- CNPJ/CPF -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" id="label_cnpj">
                        CNPJ
                    </label>
                    <div class="relative">
                        <input type="text" name="cnpj" id="cnpj" value="{{ fornecedor.cnpj if fornecedor else '' }}" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                               placeholder="00.000.000/0000-00">
                        <small id="cnpj-error" class="text-red-500 text-xs absolute -bottom-5 left-0"></small>
                        <small id="cnpj-success" class="text-green-600 text-xs absolute -bottom-5 left-0 opacity-0 transition-opacity duration-300">
                            <i class="fas fa-check-circle"></i> Documento válido
                        </small>
                    </div>
                </div>

                <!-- Nome -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="nome" value="{{ fornecedor.nome if fornecedor else '' }}" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Razão Social -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Razão Social</label>
                    <input type="text" name="razao_social" value="{{ fornecedor.razao_social if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Email -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="email" value="{{ fornecedor.email if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Telefone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" name="telefone" id="telefone" value="{{ fornecedor.telefone if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                           placeholder="(00) 00000-0000">
                </div>

                <!-- CEP -->
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                    <div class="relative">
                        <input type="text" name="cep" id="cep" value="{{ fornecedor.cep if fornecedor else '' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                               placeholder="00000-000">
                        <span id="cep-loading" class="hidden absolute right-3 top-3">
                            <i class="fas fa-spinner fa-spin text-meetcall-purple"></i>
                        </span>
                    </div>
                    <small id="cep-error" class="text-red-500 text-xs hidden">CEP não encontrado</small>
                </div>

                <!-- Endereço -->
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                    <input type="text" name="endereco" id="endereco" value="{{ fornecedor.endereco if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Número -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número</label>
                    <input type="text" name="numero" value="{{ fornecedor.numero if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Complemento -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                    <input type="text" name="complemento" value="{{ fornecedor.complemento if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>
            </div>

            <!-- Bairro, Cidade e Estado na mesma linha -->
            <div class="flex gap-4 mt-6">
                <!-- Bairro -->
                <div class="w-[40%]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                    <input type="text" name="bairro" id="bairro" value="{{ fornecedor.bairro if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Cidade -->
                <div class="w-[40%]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                    <input type="text" name="cidade" id="cidade" value="{{ fornecedor.cidade if fornecedor else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Estado -->
                <div class="w-[20%]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                    <select name="estado" id="estado" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                        <option value="">Selecione</option>
                        {% set estados = ['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'] %}
                        {% for uf in estados %}
                        <option value="{{ uf }}" {% if fornecedor and fornecedor.estado == uf %}selected{% endif %}>{{ uf }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Categoria Padrão -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Categoria Padrão <span class="text-red-500">*</span>
                    <i class="fas fa-info-circle text-gray-400 ml-2" title="Categoria padrão que será preenchida automaticamente ao lançar contas a pagar/receber deste fornecedor"></i>
                </label>
                <select name="tipo_servico_id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                    <option value="">Selecione uma categoria...</option>
                    {% if tipos_servicos %}
                        {% for tipo in tipos_servicos %}
                            {% if tipo.parent_id is none %}
                                <option value="{{ tipo.id }}" {% if fornecedor and fornecedor.tipo_servico_id == tipo.id %}selected{% endif %}>
                                    {{ tipo.nome }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>

            <!-- Seção de Contatos -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Contatos</h3>
                    <button type="button" onclick="abrirModalContato()" class="bg-meetcall-orange hover:bg-opacity-90 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-plus mr-2"></i>Adicionar Contato
                    </button>
                </div>
                <div id="contatosContainer" class="space-y-3">
                    <!-- Contatos serão inseridos aqui via JavaScript -->
                </div>
            </div>

            <!-- Botões -->
            <div class="flex justify-end mt-8 space-x-4">
                <a href="{{ url_for('fornecedores.lista') }}" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</a>
                <button type="submit" class="px-6 py-2 bg-meetcall-purple hover:bg-meetcall-purple-dark text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>{{ 'Atualizar' if fornecedor else 'Salvar' }}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Adicionar/Editar Contato -->
<div id="modalContato" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" id="modalTitle">Adicionar Contato</h3>
            <button type="button" onclick="fecharModalContato()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="formContato" onsubmit="salvarContato(event)">
            <input type="hidden" id="contatoIndex" value="">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="contatoNome" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cargo</label>
                    <input type="text" id="contatoCargo"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" id="contatoTelefone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                           placeholder="(00) 00000-0000">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="contatoEmail"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="fecharModalContato()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-meetcall-purple hover:bg-meetcall-purple-dark text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmação -->
<div id="modalConfirmacao" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="if(event.target===this) fecharModalConfirmacao()">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <div class="text-center">
                <h3 class="text-xl font-bold text-gray-900 mb-4" id="modalConfirmacaoTitle">Confirmar Ação</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-base text-gray-600" id="modalConfirmacaoMessage">Deseja confirmar esta ação?</p>
                </div>
                <div class="flex justify-center space-x-3 px-4 py-3">
                    <button type="button" onclick="fecharModalConfirmacao()" 
                            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                    <button type="button" id="btnConfirmarExclusao" onclick="confirmarExclusaoContato()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">
                        <i class="fas fa-check mr-2"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== BUSCA CEP ====================
document.getElementById('cep').addEventListener('blur', function() {
    const cep = this.value.replace(/\D/g, '');
    
    if (cep.length === 8) {
        buscarCEP(cep);
    }
});

async function buscarCEP(cep) {
    const loading = document.getElementById('cep-loading');
    const error = document.getElementById('cep-error');
    
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (data.erro) {
            error.classList.remove('hidden');
            loading.classList.add('hidden');
            return;
        }
        
        // Preencher campos automaticamente
        document.getElementById('endereco').value = data.logradouro || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('estado').value = data.uf || '';
        
        // Focar no campo número
        document.querySelector('input[name="numero"]').focus();
        
    } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        document.getElementById('cep-error').classList.remove('hidden');
    } finally {
        loading.classList.add('hidden');
    }
}

// ==================== GERENCIAMENTO DE CONTATOS ====================
let contatos = [];
let editandoIndex = -1;

{% if fornecedor and fornecedor.contatos %}
contatos = {{ fornecedor.contatos | tojson }};
{% endif %}

function renderContatos() {
    const container = document.getElementById('contatosContainer');
    container.innerHTML = '';
    
    if (contatos.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm italic">Nenhum contato adicionado</p>';
        return;
    }
    
    contatos.forEach((contato, index) => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
        div.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="grid grid-cols-2 gap-4 flex-1">
                    <div><strong class="text-sm text-gray-700">Nome:</strong> <span class="text-sm">${contato.nome || '-'}</span></div>
                    <div><strong class="text-sm text-gray-700">Cargo:</strong> <span class="text-sm">${contato.cargo || '-'}</span></div>
                    <div><strong class="text-sm text-gray-700">Telefone:</strong> <span class="text-sm">${contato.telefone || '-'}</span></div>
                    <div><strong class="text-sm text-gray-700">Email:</strong> <span class="text-sm">${contato.email || '-'}</span></div>
                </div>
                <div class="ml-4 space-x-2">
                    <button type="button" onclick="editarContato(${index})" class="text-blue-600 hover:text-blue-900" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" onclick="removerContato(${index})" class="text-red-600 hover:text-red-900" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
    
    // Atualizar campo hidden
    document.getElementById('contatos_json').value = JSON.stringify(contatos);
}

function abrirModalContato(index = -1) {
    editandoIndex = index;
    const modal = document.getElementById('modalContato');
    const title = document.getElementById('modalTitle');
    
    if (index >= 0) {
        // Editando
        title.textContent = 'Editar Contato';
        const contato = contatos[index];
        document.getElementById('contatoNome').value = contato.nome || '';
        document.getElementById('contatoCargo').value = contato.cargo || '';
        document.getElementById('contatoTelefone').value = contato.telefone || '';
        document.getElementById('contatoEmail').value = contato.email || '';
    } else {
        // Novo contato
        title.textContent = 'Adicionar Contato';
        document.getElementById('formContato').reset();
    }
    
    modal.classList.remove('hidden');
    document.getElementById('contatoNome').focus();
}

function fecharModalContato() {
    document.getElementById('modalContato').classList.add('hidden');
    document.getElementById('formContato').reset();
    editandoIndex = -1;
}

function salvarContato(event) {
    event.preventDefault();
    
    const contato = {
        nome: document.getElementById('contatoNome').value,
        cargo: document.getElementById('contatoCargo').value,
        telefone: document.getElementById('contatoTelefone').value,
        email: document.getElementById('contatoEmail').value
    };
    
    if (editandoIndex >= 0) {
        // Editando contato existente
        contatos[editandoIndex] = contato;
    } else {
        // Novo contato
        contatos.push(contato);
    }
    
    renderContatos();
    fecharModalContato();
}

function editarContato(index) {
    abrirModalContato(index);
}

// Variável global para armazenar o índice do contato a ser removido
var indiceContatoRemover = -1;

function removerContato(index) {
    indiceContatoRemover = index;
    document.getElementById('modalConfirmacaoTitle').textContent = 'Remover Contato';
    document.getElementById('modalConfirmacaoMessage').innerHTML = 
        'Tem certeza que deseja remover este contato?<br><br>' +
        '<span class="text-red-600 font-semibold">⚠️ Esta ação não pode ser desfeita!</span>';
    document.getElementById('modalConfirmacao').classList.remove('hidden');
}

function confirmarExclusaoContato() {
    if (indiceContatoRemover >= 0) {
        contatos.splice(indiceContatoRemover, 1);
        renderContatos();
        indiceContatoRemover = -1;
    }
    fecharModalConfirmacao();
}

function fecharModalConfirmacao() {
    document.getElementById('modalConfirmacao').classList.add('hidden');
    indiceContatoRemover = -1;
}

// Fechar modal ao clicar fora
document.getElementById('modalContato').addEventListener('click', function(e) {
    if (e.target === this) {
        fecharModalContato();
    }
});

// ==================== VALIDAÇÃO CNPJ/CPF ====================
function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]+/g, '');
    
    if (cnpj.length !== 14) return false;
    
    // Elimina CNPJs invalidos conhecidos
    if (/^(\d)\1+$/.test(cnpj)) return false;
    
    // Valida DVs
    let tamanho = cnpj.length - 2;
    let numeros = cnpj.substring(0, tamanho);
    let digitos = cnpj.substring(tamanho);
    let soma = 0;
    let pos = tamanho - 7;
    
    for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
    }
    
    let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado != digitos.charAt(0)) return false;
    
    tamanho = tamanho + 1;
    numeros = cnpj.substring(0, tamanho);
    soma = 0;
    pos = tamanho - 7;
    
    for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
    }
    
    resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado != digitos.charAt(1)) return false;
    
    return true;
}

function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    
    if (cpf.length !== 11) return false;
    
    // Elimina CPFs invalidos conhecidos
    if (/^(\d)\1+$/.test(cpf)) return false;
    
    // Valida 1o digito
    let add = 0;
    for (let i = 0; i < 9; i++) {
        add += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let rev = 11 - (add % 11);
    if (rev === 10 || rev === 11) rev = 0;
    if (rev !== parseInt(cpf.charAt(9))) return false;
    
    // Valida 2o digito
    add = 0;
    for (let i = 0; i < 10; i++) {
        add += parseInt(cpf.charAt(i)) * (11 - i);
    }
    rev = 11 - (add % 11);
    if (rev === 10 || rev === 11) rev = 0;
    if (rev !== parseInt(cpf.charAt(10))) return false;
    
    return true;
}

function validarDocumento() {
    var input = document.getElementById('cnpj');
    var errorMsg = document.getElementById('cnpj-error');
    var successMsg = document.getElementById('cnpj-success');
    var tipoPessoa = document.getElementById('tipo_pessoa').value;
    var valor = input.value.replace(/\D/g, '');
    
    // Limpar mensagens
    errorMsg.textContent = '';
    successMsg.classList.remove('opacity-100');
    successMsg.classList.add('opacity-0');
    input.classList.remove('border-red-500', 'border-green-500');
    
    // Se não preencheu, apenas retorna (campo não é obrigatório)
    if (valor.length === 0) {
        return true;
    }
    
    var valido = false;
    var mensagemErro = '';
    
    if (tipoPessoa === 'juridica') {
        if (valor.length !== 14) {
            mensagemErro = 'CNPJ deve ter 14 dígitos';
        } else {
            valido = validarCNPJ(valor);
            mensagemErro = 'CNPJ inválido';
        }
    } else {
        if (valor.length !== 11) {
            mensagemErro = 'CPF deve ter 11 dígitos';
        } else {
            valido = validarCPF(valor);
            mensagemErro = 'CPF inválido';
        }
    }
    
    if (!valido && valor.length > 0) {
        errorMsg.textContent = mensagemErro;
        input.classList.add('border-red-500');
        return false;
    } else if (valido) {
        // Mostrar mensagem de sucesso
        successMsg.classList.remove('opacity-0');
        successMsg.classList.add('opacity-100');
        input.classList.add('border-green-500');
        
        // Ocultar automaticamente após 2 segundos
        setTimeout(() => {
            successMsg.classList.remove('opacity-100');
            successMsg.classList.add('opacity-0');
            input.classList.remove('border-green-500');
        }, 2000);
        
        return true;
    }
    
    return true;
}

// Validar ao sair do campo
document.getElementById('cnpj').addEventListener('blur', validarDocumento);

// Validar ao submeter o formulário
document.getElementById('fornecedorForm').addEventListener('submit', function(e) {
    var cnpjInput = document.getElementById('cnpj');
    var valor = cnpjInput.value.replace(/\D/g, '');
    
    // Se preencheu o CNPJ/CPF, deve ser válido
    if (valor.length > 0) {
        if (!validarDocumento()) {
            e.preventDefault();
            cnpjInput.focus();
            
            // Mostrar mensagem de erro
            var errorMsg = document.getElementById('cnpj-error');
            errorMsg.classList.remove('hidden');
            
            // Scroll para o campo
            cnpjInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
    }
    
    // Preparar JSON de contatos antes de enviar
    document.getElementById('contatos_json').value = JSON.stringify(contatos);
});

// ==================== MÁSCARAS ====================
document.getElementById('cnpj').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    const tipoPessoa = document.getElementById('tipo_pessoa').value;
    
    if (tipoPessoa === 'juridica') {
        // CNPJ: 00.000.000/0000-00
        if (val.length > 14) val = val.substr(0, 14);
        if (val.length > 12) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        else if (val.length > 8) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
        else if (val.length > 5) val = val.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
        else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,3})/, '$1.$2');
    } else {
        // CPF: 000.000.000-00
        if (val.length > 11) val = val.substr(0, 11);
        if (val.length > 9) val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        else if (val.length > 6) val = val.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
        else if (val.length > 3) val = val.replace(/(\d{3})(\d{0,3})/, '$1.$2');
    }
    
    e.target.value = val;
});

document.getElementById('telefone').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    if (val.length > 11) val = val.substr(0, 11);
    if (val.length > 10) val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    else if (val.length > 6) val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
    else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,5})/, '($1) $2');
    e.target.value = val;
});

// Máscara para telefone do contato no modal
document.getElementById('contatoTelefone').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    if (val.length > 11) val = val.substr(0, 11);
    if (val.length > 10) val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    else if (val.length > 6) val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
    else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,5})/, '($1) $2');
    e.target.value = val;
});

document.getElementById('cep').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    if (val.length > 8) val = val.substr(0, 8);
    if (val.length > 5) val = val.replace(/(\d{5})(\d{0,3})/, '$1-$2');
    e.target.value = val;
});

// Atualizar label e placeholder ao mudar tipo de pessoa
document.getElementById('tipo_pessoa').addEventListener('change', function() {
    const label = document.getElementById('label_cnpj');
    const input = document.getElementById('cnpj');
    
    if (this.value === 'juridica') {
        label.textContent = 'CNPJ';
        input.placeholder = '00.000.000/0000-00';
    } else {
        label.textContent = 'CPF';
        input.placeholder = '000.000.000-00';
    }
    input.value = '';
    
    // Limpar validação
    document.getElementById('cnpj-error').textContent = '';
    document.getElementById('cnpj-success').classList.remove('opacity-100');
    document.getElementById('cnpj-success').classList.add('opacity-0');
    input.classList.remove('border-red-500', 'border-green-500');
});

// Renderizar contatos ao carregar
renderContatos();
</script>
{% endblock %}
