{% extends "base.html" %}

{% block title %}Nova Conta a Pagar - MeetCall System{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Nova Conta a Pagar</h1>
        <a href="{{ url_for('contas_pagar.lista') }}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
        </a>
    </div>

    <form method="POST" class="space-y-6">
        <!-- Informa√ß√µes Principais -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Informa√ß√µes Principais</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Fornecedor <span class="text-red-500">*</span>
                    </label>
                    <select name="fornecedor_id" id="fornecedor_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        {% for fornecedor in fornecedores %}
                            <option value="{{ fornecedor.id }}">{{ fornecedor.razao_social or fornecedor.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Descri√ß√£o <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="descricao" required placeholder="Ex: Aluguel - Janeiro/2025"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero do Documento</label>
                    <input type="text" name="numero_documento" placeholder="NF, Boleto, etc."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filial</label>
                    <select name="filial_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        {% for filial in filiais %}
                            <option value="{{ filial.id }}">{{ filial.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Classifica√ß√£o Cont√°bil -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Classifica√ß√£o Cont√°bil</h2>
            
            <!-- Explica√ß√£o -->
            <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 text-sm text-gray-700">
                <p class="mb-1"><strong>üí° Dica:</strong></p>
                <p class="mb-1"><strong>Tipo de Servi√ßo:</strong> Ao selecionar um fornecedor, apenas a categoria padr√£o dele e suas subcategorias ser√£o exibidas aqui. Se o fornecedor n√£o tiver categoria padr√£o, todas as op√ß√µes ser√£o mostradas.</p>
                <p><strong>Centro de Custo:</strong> Departamento que gerou a despesa (ex: Vendas, TI, Administrativo)</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Servi√ßo <span class="text-red-500">*</span>
                    </label>
                    <select name="tipo_servico_id" id="tipo_servico_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione um tipo de servi√ßo...</option>
                        {% for tipo in tipos_servicos %}
                            <option value="{{ tipo.id }}" data-parent="{{ tipo.parent_id or '' }}">
                                {% if tipo.parent_id %}‚Üí {% endif %}{{ tipo.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Centro de Custo
                        <span class="text-xs text-gray-500 font-normal">(Departamento)</span>
                    </label>
                    <select name="centro_custo_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        {% for centro in centros_custos %}
                            <option value="{{ centro.id }}">{{ centro.descricao }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conta Cont√°bil (Despesa)</label>
                    <select name="conta_contabil_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        {% for conta in contas_analiticas %}
                            <option value="{{ conta.id }}">{{ conta.codigo }} - {{ conta.descricao }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Valores e Datas -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Valores e Datas</h2>
            
            <div class="grid grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Valor Total <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500">R$</span>
                        <input type="text" name="valor_total" id="valor_total" required placeholder="0,00"
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Data de Emiss√£o <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="data_emissao" id="data_emissao" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Data de Vencimento <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="data_vencimento" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Refer√™ncia <span class="text-red-500">*</span>
                        <i class="fas fa-info-circle text-gray-400 text-xs" title="Per√≠odo de compet√™ncia para an√°lise gerencial"></i>
                    </label>
                    <input type="text" name="referencia" id="referencia" required placeholder="MM/AAAA"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Parcelas</label>
                    <input type="number" name="numero_parcelas" min="1" value="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <p class="text-xs text-gray-500 mt-1">Intervalo de 30 dias</p>
                </div>
            </div>
        </div>

        <!-- Juros e Multa -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Encargos por Atraso</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentual de Juros (%)</label>
                    <input type="number" name="percentual_juros" step="0.01" min="0" value="0" placeholder="Ex: 0.033 (1% ao m√™s)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <p class="text-xs text-gray-500 mt-1">Juros ao dia aplicado sobre atraso</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentual de Multa (%)</label>
                    <input type="number" name="percentual_multa" step="0.01" min="0" value="0" placeholder="Ex: 2"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <p class="text-xs text-gray-500 mt-1">Multa √∫nica aplicada ao atrasar</p>
                </div>
            </div>
        </div>

        <!-- Recorr√™ncia (Futuro) -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Recorr√™ncia (Opcional)</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center">
                    <input type="checkbox" name="recorrente" id="recorrente" class="mr-2">
                    <label for="recorrente" class="text-sm font-medium text-gray-700">Conta Recorrente</label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Recorr√™ncia</label>
                    <select name="tipo_recorrencia" id="tipo_recorrencia" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        <option value="mensal">Mensal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Observa√ß√µes -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
            <textarea name="observacoes" rows="3" placeholder="Informa√ß√µes adicionais..."
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple"></textarea>
        </div>

        <!-- Bot√µes -->
        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('contas_pagar.lista') }}" 
               class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-300">
                Cancelar
            </a>
            <button type="submit" 
                    class="px-6 py-2 bg-meetcall-purple text-white rounded-lg hover:bg-purple-700 transition duration-300">
                <i class="fas fa-save mr-2"></i>Salvar
            </button>
        </div>
    </form>
</div>

<script>
// Dados dos tipos de servi√ßos e fornecedores em formato JSON
const tiposServicos = {{ tipos_servicos | tojson }};
const fornecedores = {{ fornecedores | tojson }};

// Fun√ß√£o para formatar valor como moeda brasileira
function formatarMoeda(input) {
    let valor = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© d√≠gito
    valor = (parseInt(valor) / 100).toFixed(2); // Divide por 100 para ter centavos
    
    // Formata com separadores
    valor = valor.replace('.', ',');
    valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    
    input.value = valor;
}

// Aplicar formata√ß√£o no campo de valor
const valorInput = document.getElementById('valor_total');
valorInput.addEventListener('input', function() {
    formatarMoeda(this);
});

// Preencher refer√™ncia automaticamente quando selecionar data de emiss√£o
document.getElementById('data_emissao').addEventListener('change', function() {
    const dataEmissao = this.value; // formato YYYY-MM-DD
    if (dataEmissao) {
        const [ano, mes, dia] = dataEmissao.split('-');
        const referencia = `${mes}/${ano}`;
        document.getElementById('referencia').value = referencia;
    }
});

// Definir data de emiss√£o como hoje e preencher refer√™ncia por padr√£o
const dataEmissaoInput = document.querySelector('input[name="data_emissao"]');
const hoje = new Date();
const dataHoje = hoje.toISOString().split('T')[0];
dataEmissaoInput.value = dataHoje;

// Preencher refer√™ncia com m√™s/ano atual
const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
const anoAtual = hoje.getFullYear();
document.getElementById('referencia').value = `${mesAtual}/${anoAtual}`;

// Habilitar tipo de recorr√™ncia quando marcar checkbox
document.getElementById('recorrente').addEventListener('change', function() {
    document.getElementById('tipo_recorrencia').disabled = !this.checked;
});

// Fun√ß√£o para filtrar tipos de servi√ßo baseado no fornecedor
function filtrarTiposServico(fornecedorId) {
    const tipoServicoSelect = document.getElementById('tipo_servico_id');
    
    // Limpar op√ß√µes existentes
    tipoServicoSelect.innerHTML = '<option value="">Selecione um tipo de servi√ßo...</option>';
    
    if (fornecedorId) {
        const fornecedor = fornecedores.find(f => f.id == fornecedorId);
        
        console.log('Fornecedor selecionado:', fornecedor);
        console.log('Categoria do fornecedor:', fornecedor ? fornecedor.tipo_servico_id : 'sem categoria');
        
        if (fornecedor && fornecedor.tipo_servico_id) {
            // Buscar o tipo de servi√ßo principal do fornecedor
            const tipoServicoPrincipal = tiposServicos.find(ts => ts.id == fornecedor.tipo_servico_id);
            
            if (tipoServicoPrincipal) {
                // Adicionar o tipo de servi√ßo principal
                const optionPrincipal = document.createElement('option');
                optionPrincipal.value = tipoServicoPrincipal.id;
                optionPrincipal.textContent = tipoServicoPrincipal.nome;
                optionPrincipal.selected = true;
                tipoServicoSelect.appendChild(optionPrincipal);
                
                // Adicionar subcategorias (filhos) se existirem
                const subcategorias = tiposServicos.filter(ts => ts.parent_id == tipoServicoPrincipal.id);
                subcategorias.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.id;
                    option.textContent = '‚Üí ' + sub.nome;
                    tipoServicoSelect.appendChild(option);
                });
                
                console.log('‚úÖ Filtrado:', tipoServicoPrincipal.nome, 'com', subcategorias.length, 'subcategorias');
                
                // Destacar visualmente
                tipoServicoSelect.style.backgroundColor = '#e0f2fe';
                setTimeout(() => {
                    tipoServicoSelect.style.backgroundColor = '';
                }, 1500);
                
                return; // Importante: retornar aqui para n√£o executar o c√≥digo abaixo
            }
        }
        
        // Se chegou aqui, fornecedor n√£o tem categoria padr√£o
        console.log('‚ö†Ô∏è Fornecedor sem categoria padr√£o - mostrando todas');
    }
    
    // Restaurar todas as op√ß√µes (quando n√£o tem fornecedor ou n√£o tem categoria)
    tiposServicos.forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo.id;
        option.textContent = tipo.parent_id ? '‚Üí ' + tipo.nome : tipo.nome;
        tipoServicoSelect.appendChild(option);
    });
}

// Inicializar Select2 e eventos DEPOIS que o DOM carregar
$(document).ready(function() {
    // Inicializar Select2
    $('#fornecedor_id').select2({
        placeholder: 'Digite para buscar o fornecedor...',
        allowClear: true,
        language: {
            noResults: function() {
                return "Nenhum fornecedor encontrado";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        width: '100%'
    });
    
    // Evento quando selecionar um fornecedor via Select2
    $('#fornecedor_id').on('select2:select', function (e) {
        const fornecedorId = e.params.data.id;
        console.log('üîç Select2 select event - ID:', fornecedorId);
        filtrarTiposServico(fornecedorId);
    });
    
    // Evento quando limpar o Select2
    $('#fornecedor_id').on('select2:clear', function () {
        console.log('üßπ Select2 cleared');
        filtrarTiposServico(null);
    });
    
    // Aplicar estilo do Tailwind ao Select2
    $('.select2-container--default .select2-selection--single').css({
        'height': '42px',
        'border': '1px solid #d1d5db',
        'border-radius': '0.5rem',
        'padding': '0.5rem 0.75rem'
    });
    
    $('.select2-container--default .select2-selection--single .select2-selection__rendered').css({
        'line-height': '26px',
        'padding-left': '0'
    });
    
    $('.select2-container--default .select2-selection--single .select2-selection__arrow').css({
        'height': '40px'
    });
});
</script>
{% endblock %}
