{% extends "base.html" %}

{% block title %}Ratear Receita - MeetCall System{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Ratear Receita entre Produtos</h1>
        <a href="{{ url_for('contas_receber.lista') }}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
        </a>
    </div>

    <!-- Informações da Conta -->
    <div class="bg-gradient-to-r from-meetcall-purple to-purple-600 text-white rounded-lg p-6 mb-6">
        <div class="grid grid-cols-3 gap-4">
            <div>
                <div class="text-purple-200 text-sm">Cliente</div>
                <div class="text-xl font-semibold">{{ cliente.nome }}</div>
            </div>
            <div>
                <div class="text-purple-200 text-sm">Documento</div>
                <div class="text-xl font-semibold">{{ conta.numero_documento or 'Sem documento' }}</div>
            </div>
            <div>
                <div class="text-purple-200 text-sm">Valor Total</div>
                <div class="text-3xl font-bold">R$ {{ "%.2f"|format(conta.valor_total)|replace('.', ',') }}</div>
            </div>
        </div>
        <div class="mt-4 text-sm text-purple-100">
            <i class="fas fa-calendar mr-2"></i>Emissão: {{ conta.data_emissao.strftime('%d/%m/%Y') }}
            <i class="fas fa-calendar-alt ml-4 mr-2"></i>Vencimento: {{ conta.data_vencimento.strftime('%d/%m/%Y') }}
        </div>
    </div>

    {% if produtos|length == 0 %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <p class="text-yellow-800">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Este cliente não possui produtos/segmentos cadastrados. 
            <a href="{{ url_for('clientes.editar', cliente_id=cliente.id) }}" class="underline font-semibold">
                Clique aqui para cadastrar produtos
            </a>
        </p>
    </div>
    {% else %}

    <!-- Modo de Rateio -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-3">Modo de Rateio</label>
        <div class="flex space-x-4">
            <label class="flex items-center cursor-pointer">
                <input type="radio" name="modo_rateio" value="percentual" checked class="mr-2">
                <span class="text-gray-700">Por Percentual (%)</span>
            </label>
            <label class="flex items-center cursor-pointer">
                <input type="radio" name="modo_rateio" value="valor" class="mr-2">
                <span class="text-gray-700">Por Valor (R$)</span>
            </label>
        </div>
    </div>

    <!-- Lista de Rateios -->
    <div class="border rounded-lg p-4 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Distribuição por Produto</h3>
            <button type="button" onclick="adicionarProdutoRateio()" 
                    class="bg-meetcall-orange hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-plus mr-1"></i> Adicionar Produto
            </button>
        </div>

        <div id="rateios-container">
            <!-- Rateios serão adicionados aqui -->
        </div>

        <!-- Totalizador -->
        <div class="border-t-2 border-gray-300 mt-4 pt-4">
            <div class="grid grid-cols-2 gap-4 text-lg font-semibold">
                <div class="text-right">
                    <span id="label-total-percentual">TOTAL RATEADO:</span>
                    <span id="label-total-valor" class="hidden">TOTAL RATEADO:</span>
                </div>
                <div>
                    <span id="total-percentual" class="text-meetcall-purple">0%</span>
                    <span id="total-valor" class="text-meetcall-purple hidden">R$ 0,00</span>
                    <span id="diferenca-valor" class="ml-4 text-sm text-gray-600"></span>
                </div>
            </div>
            <div id="aviso-total" class="text-red-600 text-sm mt-2 hidden">
                <i class="fas fa-exclamation-circle mr-1"></i>
                <span id="aviso-total-texto"></span>
            </div>
        </div>
    </div>

    <!-- Botões -->
    <div class="flex justify-end space-x-4">
        <a href="{{ url_for('contas_receber.lista') }}" 
           class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-300">
            Cancelar
        </a>
        <button type="button" onclick="salvarRateio()" 
                class="bg-meetcall-purple hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition duration-300">
            <i class="fas fa-save mr-2"></i>Salvar Rateio
        </button>
    </div>

    {% endif %}
</div>

<script>
const valorTotal = {{ conta.valor_total }};
const produtos = {{ produtos|tojson }};
let rateios = [];
let modoRateio = 'percentual';

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Listener para mudança de modo
    document.querySelectorAll('input[name="modo_rateio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            modoRateio = this.value;
            atualizarModoRateio();
        });
    });
    
    // Se houver rateio existente, carregar
    {% if rateio_existente %}
    const rateioExistente = {{ rateio_existente|tojson }};
    rateioExistente.forEach(r => {
        adicionarProdutoRateio(r.cliente_produto_id, r.tipo_rateio === 'percentual' ? r.percentual : r.valor_fixo);
    });
    {% endif %}
});

function adicionarProdutoRateio(produtoId = null, valorInicial = null) {
    const container = document.getElementById('rateios-container');
    const index = rateios.length;
    
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-3 mb-3 rateio-item';
    div.dataset.index = index;
    
    div.innerHTML = `
        <select class="flex-1 px-3 py-2 border border-gray-300 rounded-lg produto-select" onchange="calcularTotal()">
            <option value="">Selecione um produto...</option>
            ${produtos.map(p => `<option value="${p.id}" ${produtoId == p.id ? 'selected' : ''}>${p.nome}${p.codigo ? ' (' + p.codigo + ')' : ''}</option>`).join('')}
        </select>
        
        <div class="flex items-center space-x-2 valor-input-percentual">
            <input type="number" step="0.01" min="0" max="100" placeholder="0" 
                   value="${valorInicial && modoRateio === 'percentual' ? valorInicial : ''}"
                   class="w-24 px-3 py-2 border border-gray-300 rounded-lg text-right percentual-input" 
                   onchange="calcularTotal()">
            <span class="text-gray-600">%</span>
        </div>
        
        <div class="flex items-center space-x-2 valor-input-valor hidden">
            <span class="text-gray-600">R$</span>
            <input type="number" step="0.01" min="0" placeholder="0,00"
                   value="${valorInicial && modoRateio === 'valor' ? valorInicial : ''}"
                   class="w-32 px-3 py-2 border border-gray-300 rounded-lg text-right valor-input" 
                   onchange="calcularTotal()">
        </div>
        
        <span class="text-gray-600 valor-calculado w-32 text-right">R$ 0,00</span>
        
        <button type="button" onclick="removerRateio(${index})" class="text-red-600 hover:text-red-800">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(div);
    rateios.push({});
    
    calcularTotal();
}

function removerRateio(index) {
    const item = document.querySelector(`[data-index="${index}"]`);
    if (item) {
        item.remove();
        calcularTotal();
    }
}

function atualizarModoRateio() {
    // Mostrar/ocultar campos conforme modo
    document.querySelectorAll('.valor-input-percentual').forEach(el => {
        el.classList.toggle('hidden', modoRateio === 'valor');
    });
    
    document.querySelectorAll('.valor-input-valor').forEach(el => {
        el.classList.toggle('hidden', modoRateio === 'percentual');
    });
    
    // Atualizar labels do total
    document.getElementById('label-total-percentual').classList.toggle('hidden', modoRateio === 'valor');
    document.getElementById('label-total-valor').classList.toggle('hidden', modoRateio === 'percentual');
    document.getElementById('total-percentual').classList.toggle('hidden', modoRateio === 'valor');
    document.getElementById('total-valor').classList.toggle('hidden', modoRateio === 'percentual');
    
    calcularTotal();
}

function calcularTotal() {
    const items = document.querySelectorAll('.rateio-item');
    let somaPercentual = 0;
    let somaValor = 0;
    
    items.forEach(item => {
        const percentualInput = item.querySelector('.percentual-input');
        const valorInput = item.querySelector('.valor-input');
        const valorCalculado = item.querySelector('.valor-calculado');
        
        if (modoRateio === 'percentual') {
            const percentual = parseFloat(percentualInput.value) || 0;
            somaPercentual += percentual;
            const valorRateado = (valorTotal * percentual / 100);
            valorCalculado.textContent = `R$ ${valorRateado.toFixed(2).replace('.', ',')}`;
            somaValor += valorRateado;
        } else {
            const valor = parseFloat(valorInput.value) || 0;
            somaValor += valor;
            valorCalculado.textContent = `R$ ${valor.toFixed(2).replace('.', ',')}`;
        }
    });
    
    // Atualizar totalizador
    if (modoRateio === 'percentual') {
        document.getElementById('total-percentual').textContent = somaPercentual.toFixed(2) + '%';
        document.getElementById('diferenca-valor').textContent = '';
        
        const aviso = document.getElementById('aviso-total');
        const avisoTexto = document.getElementById('aviso-total-texto');
        
        if (Math.abs(somaPercentual - 100) > 0.01) {
            aviso.classList.remove('hidden');
            avisoTexto.textContent = `A soma deve ser 100%. Diferença: ${(100 - somaPercentual).toFixed(2)}%`;
        } else {
            aviso.classList.add('hidden');
        }
    } else {
        document.getElementById('total-valor').textContent = `R$ ${somaValor.toFixed(2).replace('.', ',')}`;
        const diferenca = valorTotal - somaValor;
        document.getElementById('diferenca-valor').textContent = 
            diferenca !== 0 ? `(Diferença: R$ ${Math.abs(diferenca).toFixed(2).replace('.', ',')})` : '';
        
        const aviso = document.getElementById('aviso-total');
        const avisoTexto = document.getElementById('aviso-total-texto');
        
        if (Math.abs(diferenca) > 0.01) {
            aviso.classList.remove('hidden');
            avisoTexto.textContent = `O total deve ser R$ ${valorTotal.toFixed(2).replace('.', ',')}. Diferença: R$ ${Math.abs(diferenca).toFixed(2).replace('.', ',')}`;
        } else {
            aviso.classList.add('hidden');
        }
    }
}

function salvarRateio() {
    const items = document.querySelectorAll('.rateio-item');
    const rateiosData = [];
    
    items.forEach(item => {
        const produtoSelect = item.querySelector('.produto-select');
        const percentualInput = item.querySelector('.percentual-input');
        const valorInput = item.querySelector('.valor-input');
        
        const produtoId = parseInt(produtoSelect.value);
        if (!produtoId) return;
        
        const rateio = {
            cliente_produto_id: produtoId,
            tipo_rateio: modoRateio
        };
        
        if (modoRateio === 'percentual') {
            rateio.percentual = parseFloat(percentualInput.value) || 0;
            rateio.valor_fixo = null;
        } else {
            rateio.valor_fixo = parseFloat(valorInput.value) || 0;
            rateio.percentual = null;
        }
        
        rateiosData.push(rateio);
    });
    
    if (rateiosData.length === 0) {
        alert('Adicione pelo menos um produto ao rateio');
        return;
    }
    
    // Enviar para o servidor
    fetch('{{ url_for("contas_receber.ratear", conta_id=conta.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ rateios: rateiosData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Rateio salvo com sucesso!');
            window.location.href = '{{ url_for("contas_receber.lista") }}';
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erro ao salvar rateio: ' + error);
    });
}
</script>
{% endblock %}
