{% extends "base.html" %}

{% block title %}Nova Conta a Receber - MeetCall System{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Nova Conta a Receber</h1>
        <a href="{{ url_for('contas_receber.lista') }}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
        </a>
    </div>

    <form method="POST" class="space-y-6">
        <!-- Informa√ß√µes Principais -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Informa√ß√µes Principais</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Cliente <span class="text-red-500">*</span>
                    </label>
                    <select name="cliente_id" id="cliente_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.razao_social or cliente.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Descri√ß√£o <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="descricao" required placeholder="Ex: Aluguel - Janeiro/2025"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero do Documento</label>
                    <input type="text" name="numero_documento" placeholder="NF, Boleto, etc."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filial</label>
                    <select name="filial_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        {% for filial in filiais %}
                            <option value="{{ filial.id }}">{{ filial.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Classifica√ß√£o Cont√°bil -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Informa√ß√µes Adicionais</h2>
            
            <!-- Explica√ß√£o -->
            <div class="mb-4 p-3 bg-green-50 border-l-4 border-green-400 text-sm text-gray-700">
                <p class="mb-1"><strong>üí° Informa√ß√£o:</strong></p>
                <p>As receitas ser√£o classificadas automaticamente. Voc√™ pode opcionalmente selecionar um <strong>Produto</strong> para an√°lise de rentabilidade por segmento de cliente.</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Produto do Cliente (Opcional)
                    <span class="text-xs text-gray-500 font-normal">- Para an√°lise de rentabilidade</span>
                </label>
                <select name="cliente_produto_id" id="cliente_produto_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <option value="">Nenhum (receita geral)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Os produtos dispon√≠veis ser√£o carregados ao selecionar o cliente</p>
            </div>
        </div>

        <!-- Valores e Datas -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Valores e Datas</h2>
            
            <div class="grid grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Valor Total <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500">R$</span>
                        <input type="text" name="valor_total" id="valor_total_receber" required placeholder="0,00"
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Data de Emiss√£o <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="data_emissao" id="data_emissao_receber" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Data de Vencimento <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="data_vencimento" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Refer√™ncia <span class="text-red-500">*</span>
                        <i class="fas fa-info-circle text-gray-400 text-xs" title="Per√≠odo de compet√™ncia para an√°lise gerencial"></i>
                    </label>
                    <input type="text" name="referencia" id="referencia_receber" required placeholder="MM/AAAA"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Parcelas</label>
                    <input type="number" name="numero_parcelas" min="1" value="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <p class="text-xs text-gray-500 mt-1">Intervalo de 30 dias</p>
                </div>
            </div>
        </div>

        <!-- Juros e Multa -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Encargos por Atraso</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentual de Juros (%)</label>
                    <input type="number" name="percentual_juros" step="0.01" min="0" value="0" placeholder="Ex: 0.033 (1% ao m√™s)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <p class="text-xs text-gray-500 mt-1">Juros ao dia aplicado sobre atraso</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentual de Multa (%)</label>
                    <input type="number" name="percentual_multa" step="0.01" min="0" value="0" placeholder="Ex: 2"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <p class="text-xs text-gray-500 mt-1">Multa √∫nica aplicada ao atrasar</p>
                </div>
            </div>
        </div>

        <!-- Recorr√™ncia (Futuro) -->
        <div class="border-b pb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Recorr√™ncia (Opcional)</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center">
                    <input type="checkbox" name="recorrente" id="recorrente" class="mr-2">
                    <label for="recorrente" class="text-sm font-medium text-gray-700">Conta Recorrente</label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Recorr√™ncia</label>
                    <select name="tipo_recorrencia" id="tipo_recorrencia" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        <option value="mensal">Mensal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Observa√ß√µes -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
            <textarea name="observacoes" rows="3" placeholder="Informa√ß√µes adicionais..."
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple"></textarea>
        </div>

        <!-- Bot√µes -->
        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('contas_receber.lista') }}" 
               class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-300">
                Cancelar
            </a>
            <button type="submit" 
                    class="bg-meetcall-purple hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition duration-300">
                Cadastrar Conta
            </button>
        </div>
    </form>
</div>

<script>
// Dados dos clientes em formato JSON
const clientes = {{ clientes | tojson | safe }};

console.log('Clientes carregados:', clientes);

// Fun√ß√£o para formatar valor como moeda brasileira
function formatarMoeda(input) {
    let valor = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© d√≠gito
    valor = (parseInt(valor) / 100).toFixed(2); // Divide por 100 para ter centavos
    
    // Formata com separadores
    valor = valor.replace('.', ',');
    valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    
    input.value = valor;
}

// Aplicar formata√ß√£o no campo de valor
const valorInput = document.getElementById('valor_total_receber');
valorInput.addEventListener('input', function() {
    formatarMoeda(this);
});

// Preencher refer√™ncia automaticamente quando selecionar data de emiss√£o
document.getElementById('data_emissao_receber').addEventListener('change', function() {
    const dataEmissao = this.value; // formato YYYY-MM-DD
    if (dataEmissao) {
        const [ano, mes, dia] = dataEmissao.split('-');
        const referencia = `${mes}/${ano}`;
        document.getElementById('referencia_receber').value = referencia;
    }
});

// Definir data de emiss√£o como hoje e preencher refer√™ncia por padr√£o
const dataEmissaoInput = document.getElementById('data_emissao_receber');
const hoje = new Date();
const dataHoje = hoje.toISOString().split('T')[0];
dataEmissaoInput.value = dataHoje;

// Preencher refer√™ncia com m√™s/ano atual
const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
const anoAtual = hoje.getFullYear();
document.getElementById('referencia_receber').value = `${mesAtual}/${anoAtual}`;

// Quando selecionar um cliente, carregar seus produtos
document.getElementById('cliente_id').addEventListener('change', function() {
    const clienteId = parseInt(this.value);
    const produtoSelect = document.getElementById('cliente_produto_id');
    
    // Limpar produtos
    produtoSelect.innerHTML = '<option value="">Nenhum (receita geral)</option>';
    
    if (clienteId) {
        const cliente = clientes.find(c => c.id === clienteId);
        
        console.log('Cliente selecionado:', cliente);
        
        // Carregar produtos do cliente
        if (cliente && cliente.produtos && cliente.produtos.length > 0) {
            cliente.produtos.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = produto.nome;
                produtoSelect.appendChild(option);
            });
            console.log('Produtos carregados:', cliente.produtos.length);
        } else {
            console.log('Cliente sem produtos cadastrados');
        }
    }
});

// Habilitar tipo de recorr√™ncia quando marcar checkbox
document.getElementById('recorrente').addEventListener('change', function() {
    document.getElementById('tipo_recorrencia').disabled = !this.checked;
});

// Inicializar Select2 no campo de cliente para busca com autocompletar
$(document).ready(function() {
    $('#cliente_id').select2({
        placeholder: 'Digite para buscar o cliente...',
        allowClear: true,
        language: {
            noResults: function() {
                return "Nenhum cliente encontrado";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        width: '100%'
    });
    
    // Aplicar estilo do Tailwind ao Select2
    $('.select2-container--default .select2-selection--single').css({
        'height': '42px',
        'border': '1px solid #d1d5db',
        'border-radius': '0.5rem',
        'padding': '0.5rem 0.75rem'
    });
    
    $('.select2-container--default .select2-selection--single .select2-selection__rendered').css({
        'line-height': '26px',
        'padding-left': '0'
    });
    
    $('.select2-container--default .select2-selection--single .select2-selection__arrow').css({
        'height': '40px'
    });
});
</script>
{% endblock %}
