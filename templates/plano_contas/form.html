{% extends "base.html" %}

{% block title %}{{ 'Editar' if conta else 'Nova' }} Conta - Plano de Contas{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">{{ 'Editar' if conta else 'Nova' }} Conta Contábil</h1>
        <a href="{{ url_for('plano_contas.lista') }}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" class="space-y-6">
        <!-- Informações sobre Estrutura do Código -->
        {% if not conta %}
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                <div class="text-sm text-blue-800">
                    <p class="font-semibold mb-2">Estrutura do Código (4 níveis):</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Nível 1:</strong> 1, 2, 3... (Grupo principal - ex: 1=Receitas, 2=Despesas)</li>
                        <li><strong>Nível 2:</strong> 1.1, 1.2... (Subgrupo - ex: 1.1=Receita Bruta)</li>
                        <li><strong>Nível 3:</strong> 1.1.01, 1.1.02... (Categoria - ex: 1.1.01=Vendas)</li>
                        <li><strong>Nível 4:</strong> 1.1.01.001, 1.1.01.002... (Subcategoria - ex: 1.1.01.001=Vendas Produto A)</li>
                    </ul>
                    <p class="mt-2"><strong>Dica:</strong> O sistema calcula automaticamente o nível baseado nos pontos no código.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Código <span class="text-red-500">*</span>
                </label>
                {% if conta %}
                    <input type="text" value="{{ conta.codigo }}" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 font-mono">
                    <p class="text-xs text-gray-500 mt-1">O código não pode ser alterado após criação</p>
                {% else %}
                    <input type="text" name="codigo" required maxlength="20"
                           placeholder="Ex: 1.1.01.001"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple font-mono">
                    <p class="text-xs text-gray-500 mt-1">Use pontos para separar níveis (ex: 1.1.01.001)</p>
                {% endif %}
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Tipo <span class="text-red-500">*</span>
                </label>
                {% if conta %}
                    <input type="text" value="{{ conta.tipo|upper }}" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    <p class="text-xs text-gray-500 mt-1">O tipo não pode ser alterado após criação</p>
                {% else %}
                    <select name="tipo" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <option value="">Selecione...</option>
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                        <option value="ativo">Ativo</option>
                        <option value="passivo">Passivo</option>
                        <option value="patrimonio">Patrimônio</option>
                    </select>
                {% endif %}
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Descrição <span class="text-red-500">*</span>
            </label>
            <input type="text" name="descricao" required maxlength="255"
                   value="{{ conta.descricao if conta else '' }}"
                   placeholder="Ex: Receita de Vendas de Produtos"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Grupo DRE (opcional)</label>
                <select name="dre_grupo"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <option value="">Nenhum</option>
                    <option value="receita_bruta" {% if conta and conta.dre_grupo == 'receita_bruta' %}selected{% endif %}>Receita Bruta</option>
                    <option value="deducoes" {% if conta and conta.dre_grupo == 'deducoes' %}selected{% endif %}>Deduções</option>
                    <option value="receita_liquida" {% if conta and conta.dre_grupo == 'receita_liquida' %}selected{% endif %}>Receita Líquida</option>
                    <option value="custo_servicos" {% if conta and conta.dre_grupo == 'custo_servicos' %}selected{% endif %}>Custo de Serviços</option>
                    <option value="lucro_bruto" {% if conta and conta.dre_grupo == 'lucro_bruto' %}selected{% endif %}>Lucro Bruto</option>
                    <option value="despesas_operacionais" {% if conta and conta.dre_grupo == 'despesas_operacionais' %}selected{% endif %}>Despesas Operacionais</option>
                    <option value="ebitda" {% if conta and conta.dre_grupo == 'ebitda' %}selected{% endif %}>EBITDA</option>
                    <option value="resultado" {% if conta and conta.dre_grupo == 'resultado' %}selected{% endif %}>Resultado</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Classificação para DRE (Demonstração do Resultado do Exercício)</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ordem de Exibição</label>
                <input type="number" name="ordem" min="0"
                       value="{{ conta.ordem if conta else 0 }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                <p class="text-xs text-gray-500 mt-1">Define a ordem de exibição nos relatórios</p>
            </div>
        </div>

        {% if conta %}
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-3"></i>
                <div class="text-sm text-yellow-800">
                    <p class="font-semibold">Informações da Conta:</p>
                    <ul class="mt-2 space-y-1">
                        <li><strong>Nível:</strong> {{ conta.nivel }}</li>
                        <li><strong>Aceita Lançamento:</strong> {% if conta.aceita_lancamento %}Sim (Analítica){% else %}Não (Sintética - possui subcontas){% endif %}</li>
                        {% if conta.filhos_count > 0 %}
                            <li><strong>Subcontas:</strong> {{ conta.filhos_count }} conta(s) vinculada(s)</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('plano_contas.lista') }}" 
               class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-300">
                Cancelar
            </a>
            <button type="submit" 
                    class="bg-meetcall-purple hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition duration-300">
                {{ 'Atualizar' if conta else 'Cadastrar' }} Conta
            </button>
        </div>
    </form>
</div>
{% endblock %}
