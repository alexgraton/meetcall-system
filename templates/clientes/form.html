{% extends "base.html" %}

{% block title %}{{ 'Editar' if cliente else 'Novo' }} Cliente - MeetCall System{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">{{ 'Editar' if cliente else 'Novo' }} Cliente</h1>
        <a href="{{ url_for('clientes.lista') }}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" class="space-y-6">
        <!-- Tipo de Pessoa -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pessoa</label>
                <select name="tipo_pessoa" id="tipo_pessoa" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple"
                        onchange="toggleTipoPessoa()">
                    <option value="juridica" {% if cliente and cliente.tipo_pessoa == 'juridica' %}selected{% endif %}>Jurídica</option>
                    <option value="fisica" {% if cliente and cliente.tipo_pessoa == 'fisica' %}selected{% endif %}>Física</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Código</label>
                <input type="text" value="{{ cliente.codigo if cliente else 'Gerado automaticamente' }}" 
                       disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
        </div>

        <!-- Dados Principais -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span id="label-nome">Nome Fantasia</span> <span class="text-red-500">*</span>
                </label>
                <input type="text" name="nome" required maxlength="100"
                       value="{{ cliente.nome if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" id="label-razao">
                    Razão Social
                </label>
                <input type="text" name="razao_social" maxlength="100"
                       value="{{ cliente.razao_social|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span id="label-cnpj">CNPJ</span> <span class="text-red-500">*</span>
                </label>
                <input type="text" name="cnpj" id="cnpj" required
                       value="{{ cliente.cnpj|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Inscrição Estadual</label>
                <input type="text" name="inscricao_estadual" maxlength="20"
                       value="{{ cliente.inscricao_estadual|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
        </div>

        <!-- Endereço -->
        <div class="border-t pt-4">
            <h3 class="text-lg font-semibold mb-4">Endereço</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                    <input type="text" name="cep" id="cep" maxlength="10"
                           value="{{ cliente.cep|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Logradouro</label>
                    <input type="text" name="logradouro" maxlength="150"
                           value="{{ cliente.endereco|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número</label>
                    <input type="text" name="numero" maxlength="10"
                           value="{{ cliente.numero|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div class="col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                    <input type="text" name="complemento" maxlength="50"
                           value="{{ cliente.complemento|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                    <input type="text" name="bairro" maxlength="50"
                           value="{{ cliente.bairro|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                    <input type="text" name="cidade" maxlength="50"
                           value="{{ cliente.cidade|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">UF</label>
                    <input type="text" name="uf" maxlength="2"
                           value="{{ cliente.estado|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
        </div>

        <!-- Contato -->
        <div class="border-t pt-4">
            <h3 class="text-lg font-semibold mb-4">Contato Principal</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" name="telefone" id="telefone" maxlength="20"
                           value="{{ cliente.telefone|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="email" maxlength="100"
                           value="{{ cliente.email|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
        </div>

        <!-- Contatos Adicionais -->
        <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Contatos Adicionais</h3>
                <button type="button" onclick="addContato()" 
                        class="bg-meetcall-orange hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i> Adicionar Contato
                </button>
            </div>
            <div id="contatos-list" class="space-y-2">
                <!-- Contatos serão adicionados aqui via JavaScript -->
            </div>
            <input type="hidden" name="contatos_json" id="contatos_json" value="{{ contatos_json if contatos_json else '[]' }}">
        </div>

        <!-- Produtos/Serviços -->
        <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Produtos/Serviços</h3>
                <button type="button" onclick="addProduto()" 
                        class="bg-meetcall-purple hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i> Adicionar Produto
                </button>
            </div>
            <div id="produtos-list" class="space-y-2">
                <!-- Produtos serão adicionados aqui via JavaScript -->
            </div>
            <input type="hidden" name="produtos_json" id="produtos_json" value="{{ produtos_json if produtos_json else '[]' }}">
        </div>

        <!-- Botões -->
        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('clientes.lista') }}" 
               class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-300">
                Cancelar
            </a>
            <button type="submit" 
                    class="bg-meetcall-purple hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition duration-300">
                {{ 'Atualizar' if cliente else 'Cadastrar' }} Cliente
            </button>
        </div>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
let contatos = {{ contatos_json if contatos_json else '[]' }};
let produtos = {{ produtos_json if produtos_json else '[]' }};

$(document).ready(function() {
    // Máscaras
    $('#cep').mask('00000-000');
    $('#telefone').mask('(00) 00000-0000');
    
    // Aplicar máscara inicial
    toggleTipoPessoa();
    
    // Renderizar contatos e produtos existentes
    renderContatos();
    renderProdutos();
});

function toggleTipoPessoa() {
    const tipoPessoa = $('#tipo_pessoa').val();
    const cnpjField = $('#cnpj');
    
    if (tipoPessoa === 'juridica') {
        $('#label-nome').text('Nome Fantasia');
        $('#label-razao').text('Razão Social');
        $('#label-cnpj').text('CNPJ');
        cnpjField.mask('00.000.000/0000-00');
        cnpjField.attr('placeholder', '00.000.000/0000-00');
    } else {
        $('#label-nome').text('Nome Completo');
        $('#label-razao').text('Nome Social');
        $('#label-cnpj').text('CPF');
        cnpjField.mask('000.000.000-00');
        cnpjField.attr('placeholder', '000.000.000-00');
    }
}

// Gerenciamento de Contatos
function addContato() {
    const nome = prompt('Nome do contato:');
    if (!nome) return;
    
    const telefone = prompt('Telefone:');
    const email = prompt('Email:');
    const cargo = prompt('Cargo:');
    const observacoes = prompt('Observações:');
    
    contatos.push({
        nome: nome,
        telefone: telefone || '',
        email: email || '',
        cargo: cargo || '',
        observacoes: observacoes || ''
    });
    
    updateContatosField();
    renderContatos();
}

function editContato(index) {
    const contato = contatos[index];
    
    const nome = prompt('Nome do contato:', contato.nome);
    if (nome === null) return;
    
    const telefone = prompt('Telefone:', contato.telefone);
    const email = prompt('Email:', contato.email);
    const cargo = prompt('Cargo:', contato.cargo);
    const observacoes = prompt('Observações:', contato.observacoes);
    
    contatos[index] = {
        nome: nome,
        telefone: telefone || '',
        email: email || '',
        cargo: cargo || '',
        observacoes: observacoes || ''
    };
    
    updateContatosField();
    renderContatos();
}

function removeContato(index) {
    if (confirm('Deseja remover este contato?')) {
        contatos.splice(index, 1);
        updateContatosField();
        renderContatos();
    }
}

function renderContatos() {
    const list = $('#contatos-list');
    list.empty();
    
    if (contatos.length === 0) {
        list.html('<p class="text-gray-500 text-sm">Nenhum contato adicional cadastrado</p>');
        return;
    }
    
    contatos.forEach((contato, index) => {
        const card = $(`
            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold">${contato.nome}</div>
                        <div class="text-sm text-gray-600">
                            ${contato.cargo ? `<span class="mr-3"><i class="fas fa-briefcase mr-1"></i>${contato.cargo}</span>` : ''}
                            ${contato.telefone ? `<span class="mr-3"><i class="fas fa-phone mr-1"></i>${contato.telefone}</span>` : ''}
                            ${contato.email ? `<span><i class="fas fa-envelope mr-1"></i>${contato.email}</span>` : ''}
                        </div>
                        ${contato.observacoes ? `<div class="text-sm text-gray-500 mt-1">${contato.observacoes}</div>` : ''}
                    </div>
                    <div class="flex space-x-2 ml-3">
                        <button type="button" onclick="editContato(${index})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="removeContato(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `);
        list.append(card);
    });
}

function updateContatosField() {
    $('#contatos_json').val(JSON.stringify(contatos));
}

// Gerenciamento de Produtos
function addProduto() {
    const nome = prompt('Nome do produto/serviço:');
    if (!nome) return;
    
    const descricao = prompt('Descrição:');
    const valorStr = prompt('Valor (R$):');
    const valor = valorStr ? parseFloat(valorStr.replace(',', '.')) : 0;
    
    produtos.push({
        nome: nome,
        descricao: descricao || '',
        valor: valor
    });
    
    updateProdutosField();
    renderProdutos();
}

function editProduto(index) {
    const produto = produtos[index];
    
    const nome = prompt('Nome do produto/serviço:', produto.nome);
    if (nome === null) return;
    
    const descricao = prompt('Descrição:', produto.descricao);
    const valorStr = prompt('Valor (R$):', produto.valor.toFixed(2).replace('.', ','));
    const valor = valorStr ? parseFloat(valorStr.replace(',', '.')) : 0;
    
    produtos[index] = {
        nome: nome,
        descricao: descricao || '',
        valor: valor
    };
    
    updateProdutosField();
    renderProdutos();
}

function removeProduto(index) {
    if (confirm('Deseja remover este produto?')) {
        produtos.splice(index, 1);
        updateProdutosField();
        renderProdutos();
    }
}

function renderProdutos() {
    const list = $('#produtos-list');
    list.empty();
    
    if (produtos.length === 0) {
        list.html('<p class="text-gray-500 text-sm">Nenhum produto/serviço cadastrado</p>');
        return;
    }
    
    produtos.forEach((produto, index) => {
        const card = $(`
            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold">${produto.nome}</div>
                        <div class="text-sm text-gray-600">
                            <span class="text-meetcall-purple font-semibold">R$ ${produto.valor.toFixed(2).replace('.', ',')}</span>
                            ${produto.descricao ? `<span class="ml-3 text-gray-500">${produto.descricao}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-3">
                        <button type="button" onclick="editProduto(${index})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="removeProduto(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `);
        list.append(card);
    });
}

function updateProdutosField() {
    $('#produtos_json').val(JSON.stringify(produtos));
}
</script>
{% endblock %}
