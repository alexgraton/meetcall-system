{% extends "base.html" %}

{% block title %}{{ 'Editar' if cliente else 'Novo' }} Cliente - MeetCall System{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            {% if cliente %}Editar Cliente{% else %}Novo Cliente{% endif %}
        </h1>
        <p class="text-gray-600 mt-1">Preencha os dados do cliente</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="POST" id="clienteForm" onsubmit="return validarFormulario(event)">
            <!-- Campos hidden -->
            <input type="hidden" name="contatos_json" id="contatos_json" value="">
            <input type="hidden" name="produtos_json" id="produtos_json" value="">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tipo de Pessoa -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo <span class="text-red-500">*</span>
                    </label>
                    <select name="tipo_pessoa" id="tipo_pessoa" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                        <option value="juridica" {% if not cliente or cliente.tipo_pessoa == 'juridica' %}selected{% endif %}>Pessoa Jurídica (CNPJ)</option>
                        <option value="fisica" {% if cliente and cliente.tipo_pessoa == 'fisica' %}selected{% endif %}>Pessoa Física (CPF)</option>
                    </select>
                </div>

                <!-- CNPJ/CPF -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" id="label-cnpj">
                        CNPJ
                    </label>
                    <div class="relative">
                        <input type="text" name="cnpj" id="cnpj" value="{{ cliente.cnpj if cliente else '' }}" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                               placeholder="00.000.000/0000-00">
                        <small id="cnpj-error" class="text-red-500 text-xs absolute -bottom-5 left-0"></small>
                        <small id="cnpj-success" class="text-green-600 text-xs absolute -bottom-5 left-0 opacity-0 transition-opacity duration-300">
                            <i class="fas fa-check-circle"></i> Documento válido
                        </small>
                    </div>
                </div>

                <!-- Nome -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span id="label-nome">Nome Fantasia</span> <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="nome" id="nome" required
                           value="{{ cliente.nome if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Razão Social -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span id="label-razao">Razão Social</span>
                    </label>
                    <input type="text" name="razao_social" id="razao_social"
                           value="{{ cliente.razao_social if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Email -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="email" value="{{ cliente.email if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Telefone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" name="telefone" id="telefone" value="{{ cliente.telefone if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                           placeholder="(00) 00000-0000">
                </div>

                <!-- CEP -->
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                    <div class="relative">
                        <input type="text" name="cep" id="cep" value="{{ cliente.cep if cliente else '' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                               placeholder="00000-000">
                        <span id="cep-loading" class="hidden absolute right-3 top-3">
                            <i class="fas fa-spinner fa-spin text-meetcall-purple"></i>
                        </span>
                    </div>
                    <small id="cep-error" class="text-red-500 text-xs hidden">CEP não encontrado</small>
                </div>

                <!-- Endereço -->
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                    <input type="text" name="endereco" id="endereco" value="{{ cliente.endereco if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Número -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número</label>
                    <input type="text" name="numero" value="{{ cliente.numero if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Complemento -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                    <input type="text" name="complemento" value="{{ cliente.complemento if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

            </div>

            <!-- Bairro, Cidade e Estado na mesma linha -->
            <div class="flex gap-4 mt-6">
                <!-- Bairro -->
                <div class="w-[40%]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                    <input type="text" name="bairro" id="bairro" value="{{ cliente.bairro if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Cidade -->
                <div class="w-[40%]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                    <input type="text" name="cidade" id="cidade" value="{{ cliente.cidade if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Estado -->
                <div class="w-[20%]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                    <select name="estado" id="estado" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                        <option value="">Selecione</option>
                        {% set estados = ['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'] %}
                        {% for uf in estados %}
                        <option value="{{ uf }}" {% if cliente and cliente.estado == uf %}selected{% endif %}>{{ uf }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Categoria Padrão -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Categoria Padrão
                    <i class="fas fa-info-circle text-gray-400 ml-2" title="Categoria padrão que será preenchida automaticamente ao lançar contas a pagar/receber deste cliente"></i>
                </label>
                <select name="tipo_servico_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                    <option value="">Selecione uma categoria...</option>
                    {% if tipos_servicos %}
                        {% for tipo in tipos_servicos %}
                            {% if tipo.parent_id is none %}
                                <option value="{{ tipo.id }}" {% if cliente and cliente.tipo_servico_id == tipo.id %}selected{% endif %}>
                                    {{ tipo.nome }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>

            <!-- Seção de Contatos -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Contatos Adicionais</h3>
                    <button type="button" onclick="abrirModalContato()" class="bg-meetcall-orange hover:bg-opacity-90 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-plus mr-2"></i>Adicionar Contato
                    </button>
                </div>
                <div id="contatos-list" class="space-y-3">
                    <!-- Contatos serão inseridos aqui via JavaScript -->
                </div>
            </div>

            <!-- Seção de Produtos/Serviços -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        Produtos/Serviços
                        <i class="fas fa-info-circle text-gray-400 ml-2" title="Produtos representam segmentos de clientes para análise de rentabilidade (ex: Cartão de Crédito, Empréstimo Pessoal). Não possuem valor pré-definido, pois as receitas serão rateadas posteriormente."></i>
                    </h3>
                    <button type="button" onclick="abrirModalProduto()" class="bg-meetcall-purple hover:bg-opacity-90 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-plus mr-2"></i>Adicionar Produto
                    </button>
                </div>
                <div id="produtos-list" class="space-y-3">
                    <!-- Produtos serão inseridos aqui via JavaScript -->
                </div>
            </div>

            <!-- Botões -->
            <div class="flex justify-end mt-8 space-x-4">
                <a href="{{ url_for('clientes.lista') }}" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</a>
                <button type="submit" class="px-6 py-2 bg-meetcall-purple hover:bg-meetcall-purple-dark text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>{{ 'Atualizar' if cliente else 'Salvar' }}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Adicionar/Editar Contato -->
<div id="modalContato" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" id="modalContatoTitle">Adicionar Contato</h3>
            <button type="button" onclick="fecharModalContato()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="formContato" onsubmit="salvarContato(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="contatoNome" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cargo</label>
                    <input type="text" id="contatoCargo"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" id="contatoTelefone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                           placeholder="(00) 00000-0000">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="contatoEmail"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                    <textarea id="contatoObservacoes" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="fecharModalContato()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-meetcall-purple hover:bg-meetcall-purple-dark text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Adicionar/Editar Produto -->
<div id="modalProduto" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" id="modalProdutoTitle">Adicionar Produto/Serviço</h3>
            <button type="button" onclick="fecharModalProduto()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="formProduto" onsubmit="salvarProduto(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="produtoNome" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                           placeholder="Ex: Cartão de Crédito">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código</label>
                    <input type="text" id="produtoCodigo"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                           placeholder="Ex: CC001">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                    <textarea id="produtoDescricao" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                              placeholder="Descrição do segmento de cliente"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="fecharModalProduto()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-meetcall-purple hover:bg-meetcall-purple-dark text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmação -->
<div id="modalConfirmacao" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <div class="text-center">
                <h3 class="text-xl font-bold text-gray-900 mb-4" id="tituloConfirmacao">Confirmar Ação</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-base text-gray-600" id="mensagemConfirmacao">Deseja confirmar esta ação?</p>
                </div>
                <div class="flex justify-center space-x-3 px-4 py-3">
                    <button type="button" onclick="fecharModalConfirmacao()" 
                            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                    <button type="button" onclick="confirmarExclusao()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">
                        <i class="fas fa-check mr-2"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== VARIÁVEIS GLOBAIS ====================
let contatos = [];
let produtos = [];
let editandoContatoIndex = -1;
let editandoProdutoIndex = -1;

{% if cliente %}
    {% if cliente.contatos %}
        contatos = {{ cliente.contatos | tojson }};
    {% endif %}
    {% if cliente.produtos %}
        produtos = {{ cliente.produtos | tojson }};
    {% endif %}
{% endif %}

// ==================== BUSCA CEP ====================
document.addEventListener('DOMContentLoaded', function() {
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                buscarCEP(cep);
            }
        });
    }
});

async function buscarCEP(cep) {
    const loading = document.getElementById('cep-loading');
    const error = document.getElementById('cep-error');
    
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (data.erro) {
            error.classList.remove('hidden');
            loading.classList.add('hidden');
            return;
        }
        
        document.getElementById('endereco').value = data.logradouro || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('estado').value = data.uf || '';
        
        document.querySelector('input[name="numero"]').focus();
        
    } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        document.getElementById('cep-error').classList.remove('hidden');
    } finally {
        loading.classList.add('hidden');
    }
}

// ==================== GERENCIAMENTO DE CONTATOS ====================
function renderContatos() {
    const list = document.getElementById('contatos-list');
    list.innerHTML = '';
    
    if (contatos.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm italic">Nenhum contato adicional cadastrado</p>';
        return;
    }
    
    contatos.forEach((contato, index) => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
        div.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="grid grid-cols-2 gap-4 flex-1">
                    <div><strong class="text-sm text-gray-700">Nome:</strong> <span class="text-sm">${contato.nome || '-'}</span></div>
                    <div><strong class="text-sm text-gray-700">Cargo:</strong> <span class="text-sm">${contato.cargo || '-'}</span></div>
                    <div><strong class="text-sm text-gray-700">Telefone:</strong> <span class="text-sm">${contato.telefone || '-'}</span></div>
                    <div><strong class="text-sm text-gray-700">Email:</strong> <span class="text-sm">${contato.email || '-'}</span></div>
                    ${contato.observacoes ? `<div class="col-span-2"><strong class="text-sm text-gray-700">Observações:</strong> <span class="text-sm">${contato.observacoes}</span></div>` : ''}
                </div>
                <div class="ml-4 space-x-2">
                    <button type="button" onclick="editarContato(${index})" class="text-blue-600 hover:text-blue-900" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" onclick="removerContato(${index})" class="text-red-600 hover:text-red-900" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        list.appendChild(div);
    });
    
    document.getElementById('contatos_json').value = JSON.stringify(contatos);
}

function abrirModalContato(index = -1) {
    editandoContatoIndex = index;
    const modal = document.getElementById('modalContato');
    const title = document.getElementById('modalContatoTitle');
    
    if (index >= 0) {
        title.textContent = 'Editar Contato';
        const contato = contatos[index];
        document.getElementById('contatoNome').value = contato.nome || '';
        document.getElementById('contatoCargo').value = contato.cargo || '';
        document.getElementById('contatoTelefone').value = contato.telefone || '';
        document.getElementById('contatoEmail').value = contato.email || '';
        document.getElementById('contatoObservacoes').value = contato.observacoes || '';
    } else {
        title.textContent = 'Adicionar Contato';
        document.getElementById('formContato').reset();
    }
    
    modal.classList.remove('hidden');
    document.getElementById('contatoNome').focus();
}

function fecharModalContato() {
    document.getElementById('modalContato').classList.add('hidden');
    document.getElementById('formContato').reset();
    editandoContatoIndex = -1;
}

async function salvarContato(event) {
    event.preventDefault();
    
    const contato = {
        nome: document.getElementById('contatoNome').value,
        cargo: document.getElementById('contatoCargo').value,
        telefone: document.getElementById('contatoTelefone').value,
        email: document.getElementById('contatoEmail').value,
        observacoes: document.getElementById('contatoObservacoes').value
    };
    
    if (editandoContatoIndex >= 0) {
        contatos[editandoContatoIndex] = contato;
    } else {
        {% if cliente %}
        try {
            const response = await fetch(`/clientes/{{ cliente.id }}/contato/adicionar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(contato)
            });
            
            const data = await response.json();
            if (data.success) {
                contato.id = data.id;
                contatos.push(contato);
            } else {
                alert('Erro ao adicionar contato: ' + data.message);
                return;
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao adicionar contato');
            return;
        }
        {% else %}
        contatos.push(contato);
        {% endif %}
    }
    
    renderContatos();
    fecharModalContato();
}

function editarContato(index) {
    abrirModalContato(index);
}

function removerContato(index) {
    window.modalConfirmacaoAction = {
        callback: async () => {
            const contato = contatos[index];
            
            {% if cliente %}
            if (contato.id) {
                try {
                    const response = await fetch(`/clientes/{{ cliente.id }}/contato/${contato.id}/deletar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        alert('Erro ao remover contato do servidor');
                        return;
                    }
                } catch (error) {
                    console.error('Erro ao deletar contato:', error);
                    alert('Erro ao remover contato');
                    return;
                }
            }
            {% endif %}
            
            contatos.splice(index, 1);
            renderContatos();
        },
        tipo: 'contato',
        index: index
    };
    
    document.getElementById('tituloConfirmacao').textContent = 'Remover Contato';
    document.getElementById('mensagemConfirmacao').innerHTML = 
        'Tem certeza que deseja remover este contato?<br><br>' +
        '<span class="text-red-600 font-semibold">⚠️ Esta ação não pode ser desfeita!</span>';
    document.getElementById('modalConfirmacao').classList.remove('hidden');
}

// ==================== GERENCIAMENTO DE PRODUTOS ====================
function renderProdutos() {
    const list = document.getElementById('produtos-list');
    list.innerHTML = '';
    
    if (produtos.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm italic">Nenhum produto/serviço cadastrado</p>';
        return;
    }
    
    produtos.forEach((produto, index) => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
        div.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="font-semibold">${produto.nome}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${produto.codigo ? `<span class="bg-meetcall-purple text-white px-2 py-1 rounded text-xs mr-2">${produto.codigo}</span>` : ''}
                        ${produto.descricao ? `<span class="text-gray-500">${produto.descricao}</span>` : ''}
                    </div>
                </div>
                <div class="ml-4 space-x-2">
                    <button type="button" onclick="editarProduto(${index})" class="text-blue-600 hover:text-blue-900" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" onclick="removerProduto(${index})" class="text-red-600 hover:text-red-900" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        list.appendChild(div);
    });
    
    document.getElementById('produtos_json').value = JSON.stringify(produtos);
}

function abrirModalProduto(index = -1) {
    editandoProdutoIndex = index;
    const modal = document.getElementById('modalProduto');
    const title = document.getElementById('modalProdutoTitle');
    
    if (index >= 0) {
        title.textContent = 'Editar Produto/Serviço';
        const produto = produtos[index];
        document.getElementById('produtoNome').value = produto.nome || '';
        document.getElementById('produtoCodigo').value = produto.codigo || '';
        document.getElementById('produtoDescricao').value = produto.descricao || '';
    } else {
        title.textContent = 'Adicionar Produto/Serviço';
        document.getElementById('formProduto').reset();
    }
    
    modal.classList.remove('hidden');
    document.getElementById('produtoNome').focus();
}

function fecharModalProduto() {
    document.getElementById('modalProduto').classList.add('hidden');
    document.getElementById('formProduto').reset();
    editandoProdutoIndex = -1;
}

async function salvarProduto(event) {
    event.preventDefault();
    
    const produto = {
        nome: document.getElementById('produtoNome').value,
        codigo: document.getElementById('produtoCodigo').value,
        descricao: document.getElementById('produtoDescricao').value,
        is_active: true
    };
    
    if (editandoProdutoIndex >= 0) {
        produtos[editandoProdutoIndex] = produto;
    } else {
        {% if cliente %}
        try {
            const response = await fetch(`/clientes/{{ cliente.id }}/produto/adicionar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(produto)
            });
            
            const data = await response.json();
            if (data.success) {
                produto.id = data.id;
                produtos.push(produto);
            } else {
                alert('Erro ao adicionar produto: ' + data.message);
                return;
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao adicionar produto');
            return;
        }
        {% else %}
        produtos.push(produto);
        {% endif %}
    }
    
    renderProdutos();
    fecharModalProduto();
}

function editarProduto(index) {
    abrirModalProduto(index);
}

function removerProduto(index) {
    window.modalConfirmacaoAction = {
        callback: async () => {
            const produto = produtos[index];
            
            {% if cliente %}
            if (produto.id) {
                try {
                    const response = await fetch(`/clientes/{{ cliente.id }}/produto/${produto.id}/deletar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        alert('Erro ao remover produto do servidor');
                        return;
                    }
                } catch (error) {
                    console.error('Erro ao deletar produto:', error);
                    alert('Erro ao remover produto');
                    return;
                }
            }
            {% endif %}
            
            produtos.splice(index, 1);
            renderProdutos();
        },
        tipo: 'produto',
        index: index
    };
    
    document.getElementById('tituloConfirmacao').textContent = 'Remover Produto';
    document.getElementById('mensagemConfirmacao').innerHTML = 
        'Tem certeza que deseja remover este produto/serviço?<br><br>' +
        '<span class="text-red-600 font-semibold">⚠️ Esta ação não pode ser desfeita!</span>';
    document.getElementById('modalConfirmacao').classList.remove('hidden');
}

// ==================== MODAL DE CONFIRMAÇÃO ====================
function fecharModalConfirmacao() {
    document.getElementById('modalConfirmacao').classList.add('hidden');
    window.modalConfirmacaoAction = { callback: null, tipo: null, index: null };
}

function confirmarExclusao() {
    if (window.modalConfirmacaoAction && window.modalConfirmacaoAction.callback) {
        window.modalConfirmacaoAction.callback();
    }
    fecharModalConfirmacao();
}

// ==================== VALIDAÇÃO CNPJ/CPF ====================
function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]+/g, '');
    
    if (cnpj.length !== 14) return false;
    if (/^(\d)\1+$/.test(cnpj)) return false;
    
    let tamanho = cnpj.length - 2;
    let numeros = cnpj.substring(0, tamanho);
    let digitos = cnpj.substring(tamanho);
    let soma = 0;
    let pos = tamanho - 7;
    
    for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
    }
    
    let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado != digitos.charAt(0)) return false;
    
    tamanho = tamanho + 1;
    numeros = cnpj.substring(0, tamanho);
    soma = 0;
    pos = tamanho - 7;
    
    for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
    }
    
    resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado != digitos.charAt(1)) return false;
    
    return true;
}

function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    
    if (cpf.length !== 11) return false;
    if (/^(\d)\1+$/.test(cpf)) return false;
    
    let add = 0;
    for (let i = 0; i < 9; i++) {
        add += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let rev = 11 - (add % 11);
    if (rev === 10 || rev === 11) rev = 0;
    if (rev !== parseInt(cpf.charAt(9))) return false;
    
    add = 0;
    for (let i = 0; i < 10; i++) {
        add += parseInt(cpf.charAt(i)) * (11 - i);
    }
    rev = 11 - (add % 11);
    if (rev === 10 || rev === 11) rev = 0;
    if (rev !== parseInt(cpf.charAt(10))) return false;
    
    return true;
}

function validarDocumento() {
    const input = document.getElementById('cnpj');
    const errorMsg = document.getElementById('cnpj-error');
    const successMsg = document.getElementById('cnpj-success');
    const tipoPessoa = document.getElementById('tipo_pessoa').value;
    const valor = input.value.replace(/\D/g, '');
    
    // Limpar mensagens
    errorMsg.textContent = '';
    successMsg.classList.remove('opacity-100');
    successMsg.classList.add('opacity-0');
    input.classList.remove('border-red-500', 'border-green-500');
    
    if (valor.length === 0) {
        return true;
    }
    
    let valido = false;
    let mensagemErro = '';
    
    if (tipoPessoa === 'juridica') {
        if (valor.length !== 14) {
            mensagemErro = 'CNPJ deve ter 14 dígitos';
        } else {
            valido = validarCNPJ(valor);
            mensagemErro = 'CNPJ inválido';
        }
    } else {
        if (valor.length !== 11) {
            mensagemErro = 'CPF deve ter 11 dígitos';
        } else {
            valido = validarCPF(valor);
            mensagemErro = 'CPF inválido';
        }
    }
    
    if (!valido && valor.length > 0) {
        errorMsg.textContent = mensagemErro;
        input.classList.add('border-red-500');
        return false;
    } else if (valido) {
        // Mostrar mensagem de sucesso
        successMsg.classList.remove('opacity-0');
        successMsg.classList.add('opacity-100');
        input.classList.add('border-green-500');
        
        // Ocultar automaticamente após 2 segundos
        setTimeout(() => {
            successMsg.classList.remove('opacity-100');
            successMsg.classList.add('opacity-0');
            input.classList.remove('border-green-500');
        }, 2000);
        
        return true;
    }
    
    return true;
}

// ==================== MÁSCARAS ====================
document.addEventListener('DOMContentLoaded', function() {
    const cnpjInput = document.getElementById('cnpj');
    if (cnpjInput) {
        cnpjInput.addEventListener('blur', validarDocumento);
        
        cnpjInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            const tipoPessoa = document.getElementById('tipo_pessoa').value;
            
            if (tipoPessoa === 'juridica') {
                if (val.length > 14) val = val.substr(0, 14);
                if (val.length > 12) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                else if (val.length > 8) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
                else if (val.length > 5) val = val.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
                else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,3})/, '$1.$2');
            } else {
                if (val.length > 11) val = val.substr(0, 11);
                if (val.length > 9) val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                else if (val.length > 6) val = val.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
                else if (val.length > 3) val = val.replace(/(\d{3})(\d{0,3})/, '$1.$2');
            }
            
            e.target.value = val;
        });
    }
    
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 11) val = val.substr(0, 11);
            if (val.length > 10) val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            else if (val.length > 6) val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            e.target.value = val;
        });
    }
    
    const contatoTelefoneInput = document.getElementById('contatoTelefone');
    if (contatoTelefoneInput) {
        contatoTelefoneInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 11) val = val.substr(0, 11);
            if (val.length > 10) val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            else if (val.length > 6) val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            e.target.value = val;
        });
    }
    
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 8) val = val.substr(0, 8);
            if (val.length > 5) val = val.replace(/(\d{5})(\d{0,3})/, '$1-$2');
            e.target.value = val;
        });
    }
    
    const tipoPessoaSelect = document.getElementById('tipo_pessoa');
    if (tipoPessoaSelect) {
        tipoPessoaSelect.addEventListener('change', function() {
            const label = document.getElementById('label-cnpj');
            const labelNome = document.getElementById('label-nome');
            const labelRazao = document.getElementById('label-razao');
            const input = document.getElementById('cnpj');
            
            if (this.value === 'juridica') {
                label.textContent = 'CNPJ';
                labelNome.textContent = 'Nome Fantasia';
                labelRazao.textContent = 'Razão Social';
                input.placeholder = '00.000.000/0000-00';
            } else {
                label.textContent = 'CPF';
                labelNome.textContent = 'Nome Completo';
                labelRazao.textContent = 'Nome Social';
                input.placeholder = '000.000.000-00';
            }
            input.value = '';
            
            document.getElementById('cnpj-error').textContent = '';
            document.getElementById('cnpj-success').classList.remove('opacity-100');
            document.getElementById('cnpj-success').classList.add('opacity-0');
            input.classList.remove('border-red-500', 'border-green-500');
        });
    }
    
    // Fechar modais ao clicar fora
    document.getElementById('modalContato').addEventListener('click', function(e) {
        if (e.target === this) fecharModalContato();
    });
    
    document.getElementById('modalProduto').addEventListener('click', function(e) {
        if (e.target === this) fecharModalProduto();
    });
    
    document.getElementById('modalConfirmacao').addEventListener('click', function(e) {
        if (e.target === this) fecharModalConfirmacao();
    });
    
    // Renderizar ao carregar
    renderContatos();
    renderProdutos();
});

// Validar formulário antes de enviar
function validarFormulario(event) {
    const cnpjInput = document.getElementById('cnpj');
    const valor = cnpjInput.value.replace(/\D/g, '');
    
    if (valor.length > 0) {
        if (!validarDocumento()) {
            event.preventDefault();
            cnpjInput.focus();
            cnpjInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
    }
    
    document.getElementById('contatos_json').value = JSON.stringify(contatos);
    document.getElementById('produtos_json').value = JSON.stringify(produtos);
    return true;
}
</script>
{% endblock %}
