{% extends "base.html" %}

{% block title %}{{ 'Editar' if cliente else 'Novo' }} Cliente - MeetCall System{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">{{ 'Editar' if cliente else 'Novo' }} Cliente</h1>
        <a href="{{ url_for('clientes.lista') }}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" class="space-y-6">
        <!-- Tipo de Pessoa -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pessoa</label>
                <select name="tipo_pessoa" id="tipo_pessoa" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                    <option value="juridica" {% if cliente and cliente.tipo_pessoa == 'juridica' %}selected{% endif %}>Jurídica</option>
                    <option value="fisica" {% if cliente and cliente.tipo_pessoa == 'fisica' %}selected{% endif %}>Física</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Código</label>
                <input type="text" value="{{ cliente.codigo if cliente else 'Gerado automaticamente' }}" 
                       disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
        </div>

        <!-- Dados Principais -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span id="label-nome">Nome Fantasia</span> <span class="text-red-500">*</span>
                </label>
                <input type="text" name="nome" id="nome" required maxlength="100"
                       value="{{ cliente.nome if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" id="label-razao">
                    Razão Social
                </label>
                <input type="text" name="razao_social" id="razao_social" maxlength="100"
                       value="{{ cliente.razao_social|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span id="label-cnpj">CNPJ</span> <span class="text-red-500">*</span>
                </label>
                <input type="text" name="cnpj" id="cnpj" required
                       value="{{ cliente.cnpj|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Inscrição Estadual</label>
                <input type="text" name="inscricao_estadual" id="inscricao_estadual" maxlength="20"
                       value="{{ cliente.inscricao_estadual|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
        </div>

        <!-- Endereço -->
        <div class="border-t pt-4">
            <h3 class="text-lg font-semibold mb-4">Endereço</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                    <div class="relative">
                        <input type="text" name="cep" id="cep" maxlength="10"
                               value="{{ cliente.cep|default('', true) if cliente else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <span id="cep-loading" class="hidden absolute right-3 top-3">
                            <i class="fas fa-spinner fa-spin text-meetcall-purple"></i>
                        </span>
                    </div>
                    <small id="cep-error" class="text-red-500 text-xs hidden">CEP não encontrado</small>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Logradouro</label>
                    <input type="text" name="logradouro" id="logradouro" maxlength="150"
                           value="{{ cliente.endereco|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número</label>
                    <input type="text" name="numero" id="numero" maxlength="10"
                           value="{{ cliente.numero|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div class="col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                    <input type="text" name="complemento" id="complemento" maxlength="50"
                           value="{{ cliente.complemento|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                    <input type="text" name="bairro" id="bairro" maxlength="50"
                           value="{{ cliente.bairro|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                    <input type="text" name="cidade" id="cidade" maxlength="50"
                           value="{{ cliente.cidade|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">UF</label>
                    <input type="text" name="uf" id="uf" maxlength="2"
                           value="{{ cliente.estado|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
        </div>

        <!-- Contato Principal -->
        <div class="border-t pt-4">
            <h3 class="text-lg font-semibold mb-4">Contato Principal</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" name="telefone" id="telefone" maxlength="20"
                           value="{{ cliente.telefone|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="email" maxlength="100"
                           value="{{ cliente.email|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
        </div>

        <!-- Contatos Adicionais -->
        <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Contatos Adicionais</h3>
                <button type="button" onclick="abrirModalContato()" 
                        class="bg-meetcall-orange hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i> Adicionar Contato
                </button>
            </div>
            <div id="contatos-list" class="space-y-2">
                <!-- Contatos serão adicionados aqui via JavaScript -->
            </div>
            <input type="hidden" name="contatos_json" id="contatos_json" value="">
        </div>

        <!-- Produtos/Serviços -->
        <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Produtos/Serviços</h3>
                <button type="button" onclick="abrirModalProduto()" 
                        class="bg-meetcall-purple hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i> Adicionar Produto
                </button>
            </div>
            <div id="produtos-list" class="space-y-2">
                <!-- Produtos serão adicionados aqui via JavaScript -->
            </div>
            <input type="hidden" name="produtos_json" id="produtos_json" value="">
        </div>

        <!-- Botões -->
        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('clientes.lista') }}" 
               class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-300">
                Cancelar
            </a>
            <button type="submit" 
                    class="bg-meetcall-purple hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition duration-300">
                {{ 'Atualizar' if cliente else 'Cadastrar' }} Cliente
            </button>
        </div>
    </form>
</div>

<!-- Modal para Contato -->
<div id="modalContato" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" id="modalContatoTitle">Adicionar Contato</h3>
            <button type="button" onclick="fecharModalContato()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="formContato" onsubmit="salvarContato(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="contatoNome" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cargo</label>
                    <input type="text" id="contatoCargo"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" id="contatoTelefone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple"
                           placeholder="(00) 00000-0000">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="contatoEmail"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                    <textarea id="contatoObservacoes" rows="2"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="fecharModalContato()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-meetcall-orange hover:bg-orange-600 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Produto -->
<div id="modalProduto" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" id="modalProdutoTitle">Adicionar Produto/Serviço</h3>
            <button type="button" onclick="fecharModalProduto()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="formProduto" onsubmit="salvarProduto(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="produtoNome" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                    <textarea id="produtoDescricao" rows="2"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
                    <input type="text" id="produtoValor" placeholder="0,00"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="fecharModalProduto()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-meetcall-purple hover:bg-purple-700 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// ==================== DADOS INICIAIS ====================
let contatos = {{ contatos_json if contatos_json else '[]' }};
let produtos = {{ produtos_json if produtos_json else '[]' }};
let editandoContatoIndex = -1;
let editandoProdutoIndex = -1;

// ==================== BUSCA CEP ====================
document.getElementById('cep').addEventListener('blur', function() {
    const cep = this.value.replace(/\D/g, '');
    
    if (cep.length === 8) {
        buscarCEP(cep);
    }
});

async function buscarCEP(cep) {
    const loading = document.getElementById('cep-loading');
    const error = document.getElementById('cep-error');
    
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (data.erro) {
            error.classList.remove('hidden');
            loading.classList.add('hidden');
            return;
        }
        
        // Preencher campos
        document.getElementById('logradouro').value = data.logradouro || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('uf').value = data.uf || '';
        
        // Focar no número
        document.getElementById('numero').focus();
        
    } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        document.getElementById('cep-error').classList.remove('hidden');
    } finally {
        loading.classList.add('hidden');
    }
}

// ==================== MÁSCARAS ====================
document.getElementById('cnpj').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    const tipoPessoa = document.getElementById('tipo_pessoa').value;
    
    if (tipoPessoa === 'juridica') {
        if (val.length > 14) val = val.substr(0, 14);
        if (val.length > 12) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        else if (val.length > 8) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
        else if (val.length > 5) val = val.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
        else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,3})/, '$1.$2');
    } else {
        if (val.length > 11) val = val.substr(0, 11);
        if (val.length > 9) val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        else if (val.length > 6) val = val.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
        else if (val.length > 3) val = val.replace(/(\d{3})(\d{0,3})/, '$1.$2');
    }
    
    e.target.value = val;
});

function aplicarMascaraTelefone(input) {
    input.addEventListener('input', function(e) {
        let val = e.target.value.replace(/\D/g, '');
        if (val.length > 11) val = val.substr(0, 11);
        if (val.length > 10) val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        else if (val.length > 6) val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,5})/, '($1) $2');
        e.target.value = val;
    });
}

aplicarMascaraTelefone(document.getElementById('telefone'));
aplicarMascaraTelefone(document.getElementById('contatoTelefone'));

document.getElementById('cep').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    if (val.length > 8) val = val.substr(0, 8);
    if (val.length > 5) val = val.replace(/(\d{5})(\d{0,3})/, '$1-$2');
    e.target.value = val;
});

// Máscara para valor monetário
document.getElementById('produtoValor').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    if (val.length > 0) {
        val = (parseInt(val) / 100).toFixed(2).replace('.', ',');
    }
    e.target.value = val;
});

// Toggle tipo pessoa
document.getElementById('tipo_pessoa').addEventListener('change', function() {
    const tipoPessoa = this.value;
    const labelNome = document.getElementById('label-nome');
    const labelRazao = document.getElementById('label-razao');
    const labelCnpj = document.getElementById('label-cnpj');
    const inputCnpj = document.getElementById('cnpj');
    
    if (tipoPessoa === 'juridica') {
        labelNome.textContent = 'Nome Fantasia';
        labelRazao.textContent = 'Razão Social';
        labelCnpj.textContent = 'CNPJ';
        inputCnpj.placeholder = '00.000.000/0000-00';
    } else {
        labelNome.textContent = 'Nome Completo';
        labelRazao.textContent = 'Nome Social';
        labelCnpj.textContent = 'CPF';
        inputCnpj.placeholder = '000.000.000-00';
    }
    inputCnpj.value = '';
});

// ==================== CONTATOS ====================
function abrirModalContato(index = -1) {
    editandoContatoIndex = index;
    const modal = document.getElementById('modalContato');
    const title = document.getElementById('modalContatoTitle');
    
    if (index >= 0) {
        title.textContent = 'Editar Contato';
        const contato = contatos[index];
        document.getElementById('contatoNome').value = contato.nome || '';
        document.getElementById('contatoCargo').value = contato.cargo || '';
        document.getElementById('contatoTelefone').value = contato.telefone || '';
        document.getElementById('contatoEmail').value = contato.email || '';
        document.getElementById('contatoObservacoes').value = contato.observacoes || '';
    } else {
        title.textContent = 'Adicionar Contato';
        document.getElementById('formContato').reset();
    }
    
    modal.classList.remove('hidden');
    document.getElementById('contatoNome').focus();
}

function fecharModalContato() {
    document.getElementById('modalContato').classList.add('hidden');
    document.getElementById('formContato').reset();
    editandoContatoIndex = -1;
}

function salvarContato(event) {
    event.preventDefault();
    
    const contato = {
        nome: document.getElementById('contatoNome').value,
        cargo: document.getElementById('contatoCargo').value,
        telefone: document.getElementById('contatoTelefone').value,
        email: document.getElementById('contatoEmail').value,
        observacoes: document.getElementById('contatoObservacoes').value
    };
    
    if (editandoContatoIndex >= 0) {
        contatos[editandoContatoIndex] = contato;
    } else {
        contatos.push(contato);
    }
    
    renderContatos();
    fecharModalContato();
}

function editarContato(index) {
    abrirModalContato(index);
}

function removerContato(index) {
    if (confirm('Deseja remover este contato?')) {
        contatos.splice(index, 1);
        renderContatos();
    }
}

function renderContatos() {
    const list = document.getElementById('contatos-list');
    list.innerHTML = '';
    
    if (contatos.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">Nenhum contato adicional cadastrado</p>';
    } else {
        contatos.forEach((contato, index) => {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-3 rounded border border-gray-200';
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold">${contato.nome}</div>
                        <div class="text-sm text-gray-600">
                            ${contato.cargo ? `<span class="mr-3"><i class="fas fa-briefcase mr-1"></i>${contato.cargo}</span>` : ''}
                            ${contato.telefone ? `<span class="mr-3"><i class="fas fa-phone mr-1"></i>${contato.telefone}</span>` : ''}
                            ${contato.email ? `<span><i class="fas fa-envelope mr-1"></i>${contato.email}</span>` : ''}
                        </div>
                        ${contato.observacoes ? `<div class="text-sm text-gray-500 mt-1">${contato.observacoes}</div>` : ''}
                    </div>
                    <div class="flex space-x-2 ml-3">
                        <button type="button" onclick="editarContato(${index})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="removerContato(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }
    
    document.getElementById('contatos_json').value = JSON.stringify(contatos);
}

// ==================== PRODUTOS ====================
function abrirModalProduto(index = -1) {
    editandoProdutoIndex = index;
    const modal = document.getElementById('modalProduto');
    const title = document.getElementById('modalProdutoTitle');
    
    if (index >= 0) {
        title.textContent = 'Editar Produto/Serviço';
        const produto = produtos[index];
        document.getElementById('produtoNome').value = produto.nome || '';
        document.getElementById('produtoDescricao').value = produto.descricao || '';
        document.getElementById('produtoValor').value = produto.valor ? produto.valor.toFixed(2).replace('.', ',') : '';
    } else {
        title.textContent = 'Adicionar Produto/Serviço';
        document.getElementById('formProduto').reset();
    }
    
    modal.classList.remove('hidden');
    document.getElementById('produtoNome').focus();
}

function fecharModalProduto() {
    document.getElementById('modalProduto').classList.add('hidden');
    document.getElementById('formProduto').reset();
    editandoProdutoIndex = -1;
}

function salvarProduto(event) {
    event.preventDefault();
    
    const valorStr = document.getElementById('produtoValor').value.replace(',', '.');
    const produto = {
        nome: document.getElementById('produtoNome').value,
        descricao: document.getElementById('produtoDescricao').value,
        valor: parseFloat(valorStr) || 0
    };
    
    if (editandoProdutoIndex >= 0) {
        produtos[editandoProdutoIndex] = produto;
    } else {
        produtos.push(produto);
    }
    
    renderProdutos();
    fecharModalProduto();
}

function editarProduto(index) {
    abrirModalProduto(index);
}

function removerProduto(index) {
    if (confirm('Deseja remover este produto?')) {
        produtos.splice(index, 1);
        renderProdutos();
    }
}

function renderProdutos() {
    const list = document.getElementById('produtos-list');
    list.innerHTML = '';
    
    if (produtos.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">Nenhum produto/serviço cadastrado</p>';
    } else {
        produtos.forEach((produto, index) => {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-3 rounded border border-gray-200';
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold">${produto.nome}</div>
                        <div class="text-sm text-gray-600">
                            <span class="text-meetcall-purple font-semibold">R$ ${produto.valor.toFixed(2).replace('.', ',')}</span>
                            ${produto.descricao ? `<span class="ml-3 text-gray-500">${produto.descricao}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-3">
                        <button type="button" onclick="editarProduto(${index})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="removerProduto(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }
    
    document.getElementById('produtos_json').value = JSON.stringify(produtos);
}

// Fechar modais ao clicar fora
document.getElementById('modalContato').addEventListener('click', function(e) {
    if (e.target === this) fecharModalContato();
});

document.getElementById('modalProduto').addEventListener('click', function(e) {
    if (e.target === this) fecharModalProduto();
});

// Renderizar ao carregar
renderContatos();
renderProdutos();
</script>
{% endblock %}
