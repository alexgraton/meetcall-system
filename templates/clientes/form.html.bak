{% extends "base.html" %}

{% block title %}{{ 'Editar' if cliente else 'Novo' }} Cliente - MeetCall System{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            {% if cliente %}Editar Cliente{% else %}Novo Cliente{% endif %}
        </h1>
        <p class="text-gray-600 mt-1">Preencha os dados do cliente</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="POST" onsubmit="return validarFormulario(event)">
            <!-- Campos hidden -->
            <input type="hidden" name="contatos_json" id="contatos_json" value="">
            <input type="hidden" name="produtos_json" id="produtos_json" value="">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tipo de Pessoa -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo <span class="text-red-500">*</span>
                    </label>
                    <select name="tipo_pessoa" id="tipo_pessoa" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                        <option value="juridica" {% if not cliente or cliente.tipo_pessoa == 'juridica' %}selected{% endif %}>Pessoa Jurídica (CNPJ)</option>
                        <option value="fisica" {% if cliente and cliente.tipo_pessoa == 'fisica' %}selected{% endif %}>Pessoa Física (CPF)</option>
                    </select>
                </div>
                
                <!-- Código -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código</label>
                    <input type="text" value="{{ cliente.codigo if cliente else 'Gerado automaticamente' }}" 
                           disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                </div>

                <!-- CNPJ/CPF -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" id="label-cnpj">
                        CNPJ
                    </label>
                    <input type="text" name="cnpj" id="cnpj" value="{{ cliente.cnpj if cliente else '' }}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent"
                           placeholder="00.000.000/0000-00">
                    <small id="cnpj-error" class="text-red-500 text-xs hidden mt-1"></small>
                    <small id="cnpj-success" class="text-green-600 text-xs hidden mt-1"><i class="fas fa-check-circle"></i> Documento válido</small>
                </div>

                <!-- Nome -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span id="label-nome">Nome Fantasia</span> <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="nome" id="nome" required maxlength="100"
                           value="{{ cliente.nome if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Razão Social -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span id="label-razao">Razão Social</span>
                    </label>
                    <input type="text" name="razao_social" id="razao_social" maxlength="100"
                           value="{{ cliente.razao_social if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Email -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="email" maxlength="100"
                           value="{{ cliente.email if cliente else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- Telefone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" name="telefone" id="telefone" maxlength="20"
                           value="{{ cliente.telefone if cliente else '' }}"
                           placeholder="(00) 00000-0000"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple focus:border-transparent">
                </div>

                <!-- CEP -->
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" id="label-razao">
                    Razão Social
                </label>
                <input type="text" name="razao_social" id="razao_social" maxlength="100"
                       value="{{ cliente.razao_social|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span id="label-cnpj">CNPJ</span> <span class="text-red-500">*</span>
                </label>
                <input type="text" name="cnpj" id="cnpj" required
                       value="{{ cliente.cnpj|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Inscrição Estadual</label>
                <input type="text" name="inscricao_estadual" id="inscricao_estadual" maxlength="20"
                       value="{{ cliente.inscricao_estadual|default('', true) if cliente else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
            </div>
        </div>

        <!-- Endereço -->
        <div class="border-t pt-4">
            <h3 class="text-lg font-semibold mb-4">Endereço</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                    <div class="relative">
                        <input type="text" name="cep" id="cep" maxlength="10"
                               value="{{ cliente.cep|default('', true) if cliente else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                        <span id="cep-loading" class="hidden absolute right-3 top-3">
                            <i class="fas fa-spinner fa-spin text-meetcall-purple"></i>
                        </span>
                    </div>
                    <small id="cep-error" class="text-red-500 text-xs hidden">CEP não encontrado</small>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Logradouro</label>
                    <input type="text" name="logradouro" id="logradouro" maxlength="150"
                           value="{{ cliente.endereco|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número</label>
                    <input type="text" name="numero" id="numero" maxlength="10"
                           value="{{ cliente.numero|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div class="col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                    <input type="text" name="complemento" id="complemento" maxlength="50"
                           value="{{ cliente.complemento|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                    <input type="text" name="bairro" id="bairro" maxlength="50"
                           value="{{ cliente.bairro|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                    <input type="text" name="cidade" id="cidade" maxlength="50"
                           value="{{ cliente.cidade|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">UF</label>
                    <input type="text" name="uf" id="uf" maxlength="2"
                           value="{{ cliente.estado|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
        </div>

        <!-- Contato Principal -->
        <div class="border-t pt-4">
            <h3 class="text-lg font-semibold mb-4">Contato Principal</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" name="telefone" id="telefone" maxlength="20"
                           value="{{ cliente.telefone|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="email" maxlength="100"
                           value="{{ cliente.email|default('', true) if cliente else '' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-meetcall-purple">
                </div>
            </div>
        </div>

        <!-- Contatos Adicionais -->
        <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Contatos Adicionais</h3>
                <button type="button" onclick="abrirModalContato()" 
                        class="bg-meetcall-orange hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i> Adicionar Contato
                </button>
            </div>
            <div id="contatos-list" class="space-y-2">
                <!-- Contatos serão adicionados aqui via JavaScript -->
            </div>
            <input type="hidden" name="contatos_json" id="contatos_json" value="">
        </div>

        <!-- Produtos/Serviços -->
        <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Produtos/Serviços</h3>
                <button type="button" onclick="abrirModalProduto()" 
                        class="bg-meetcall-purple hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i> Adicionar Produto
                </button>
            </div>
            <div id="produtos-list" class="space-y-2">
                <!-- Produtos serão adicionados aqui via JavaScript -->
            </div>
            <input type="hidden" name="produtos_json" id="produtos_json" value="">
        </div>

        <!-- Botões -->
        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('clientes.lista') }}" 
               class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-300">
                Cancelar
            </a>
            <button type="submit" 
                    class="bg-meetcall-purple hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition duration-300">
                {{ 'Atualizar' if cliente else 'Cadastrar' }} Cliente
            </button>
        </div>
    </form>
</div>

<!-- Modal para Contato -->
<div id="modalContato" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" id="modalContatoTitle">Adicionar Contato</h3>
            <button type="button" onclick="fecharModalContato()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="formContato" onsubmit="salvarContato(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="contatoNome" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cargo</label>
                    <input type="text" id="contatoCargo"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="text" id="contatoTelefone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple"
                           placeholder="(00) 00000-0000">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="contatoEmail"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                    <textarea id="contatoObservacoes" rows="2"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="fecharModalContato()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-meetcall-orange hover:bg-orange-600 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Produto -->
<div id="modalProduto" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800" id="modalProdutoTitle">Adicionar Produto/Serviço</h3>
            <button type="button" onclick="fecharModalProduto()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="formProduto" onsubmit="salvarProduto(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nome do Produto/Segmento <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="produtoNome" required placeholder="Ex: Cartão de Crédito, Empréstimo Pessoal, PA Fixa"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código (Opcional)</label>
                    <input type="text" id="produtoCodigo" placeholder="Ex: CC, EMP, PA"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                    <textarea id="produtoDescricao" rows="2" placeholder="Informações adicionais sobre o produto"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-meetcall-purple"></textarea>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Produtos/Segmentos</strong> são divisões do cliente usadas para análise de rentabilidade.
                        Exemplo: Para o cliente "Banco Santander", os produtos podem ser "Cartão de Crédito", "Empréstimo Pessoal", etc.
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="fecharModalProduto()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-meetcall-purple hover:bg-purple-700 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="modalConfirmacao" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-trash-alt text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2" id="tituloConfirmacao">Confirmar Exclusão</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-base text-gray-700" id="mensagemConfirmacao">Deseja realmente remover este item?</p>
            </div>
            <div class="flex justify-center gap-4 px-4 py-3">
                <button type="button" onclick="fecharModalConfirmacao()" 
                        class="px-6 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-lg hover:bg-gray-400 transition duration-300">
                    Cancelar
                </button>
                <button type="button" onclick="confirmarExclusao()" 
                        class="px-6 py-2 bg-red-600 text-white text-base font-medium rounded-lg hover:bg-red-700 transition duration-300">
                    Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== DADOS INICIAIS ====================
let contatos = {{ contatos_json | safe if contatos_json else '[]' }};
let produtos = {{ produtos_json | safe if produtos_json else '[]' }};
let editandoContatoIndex = -1;
let editandoProdutoIndex = -1;

// Controle do modal de confirmação
window.modalConfirmacaoAction = {
    callback: null,
    tipo: null,
    index: null
};

// ==================== BUSCA CEP ====================
document.addEventListener('DOMContentLoaded', function() {
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            
            if (cep.length === 8) {
                buscarCEP(cep);
            }
        });
    }
});

async function buscarCEP(cep) {
    const loading = document.getElementById('cep-loading');
    const error = document.getElementById('cep-error');
    
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (data.erro) {
            error.classList.remove('hidden');
            loading.classList.add('hidden');
            return;
        }
        
        // Preencher campos
        document.getElementById('logradouro').value = data.logradouro || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('uf').value = data.uf || '';
        
        // Focar no número
        document.getElementById('numero').focus();
        
    } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        document.getElementById('cep-error').classList.remove('hidden');
    } finally {
        loading.classList.add('hidden');
    }
}

// ==================== MÁSCARAS ====================
function aplicarMascaraTelefone(input) {
    if (!input) return;
    input.addEventListener('input', function(e) {
        let val = e.target.value.replace(/\D/g, '');
        if (val.length > 11) val = val.substr(0, 11);
        if (val.length > 10) val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        else if (val.length > 6) val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,5})/, '($1) $2');
        e.target.value = val;
    });
}

// Inicializar máscaras e eventos quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    // Máscara CNPJ/CPF
    const cnpjInput = document.getElementById('cnpj');
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            const tipoPessoa = document.getElementById('tipo_pessoa').value;
            
            if (tipoPessoa === 'juridica') {
                if (val.length > 14) val = val.substr(0, 14);
                if (val.length > 12) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                else if (val.length > 8) val = val.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
                else if (val.length > 5) val = val.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
                else if (val.length > 2) val = val.replace(/(\d{2})(\d{0,3})/, '$1.$2');
            } else {
                if (val.length > 11) val = val.substr(0, 11);
                if (val.length > 9) val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                else if (val.length > 6) val = val.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
                else if (val.length > 3) val = val.replace(/(\d{3})(\d{0,3})/, '$1.$2');
            }
            
            e.target.value = val;
        });
    }

    // Máscara telefone
    aplicarMascaraTelefone(document.getElementById('telefone'));
    aplicarMascaraTelefone(document.getElementById('contatoTelefone'));

    // Máscara CEP
    const cepInputMask = document.getElementById('cep');
    if (cepInputMask) {
        cepInputMask.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 8) val = val.substr(0, 8);
            if (val.length > 5) val = val.replace(/(\d{5})(\d{0,3})/, '$1-$2');
            e.target.value = val;
        });
    }

    // Máscara para valor monetário (se existir)
    const produtoValorInput = document.getElementById('produtoValor');
    if (produtoValorInput) {
        produtoValorInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 0) {
                val = (parseInt(val) / 100).toFixed(2).replace('.', ',');
            }
            e.target.value = val;
        });
    }

    // Toggle tipo pessoa
    const tipoPessoaSelect = document.getElementById('tipo_pessoa');
    if (tipoPessoaSelect) {
        tipoPessoaSelect.addEventListener('change', function() {
            const tipoPessoa = this.value;
            const labelNome = document.getElementById('label-nome');
            const labelRazao = document.getElementById('label-razao');
            const labelCnpj = document.getElementById('label-cnpj');
            const inputCnpj = document.getElementById('cnpj');
            
            if (tipoPessoa === 'juridica') {
                labelNome.textContent = 'Nome Fantasia';
                labelRazao.textContent = 'Razão Social';
                labelCnpj.textContent = 'CNPJ';
                inputCnpj.placeholder = '00.000.000/0000-00';
            } else {
                labelNome.textContent = 'Nome Completo';
                labelRazao.textContent = 'Nome Social';
                labelCnpj.textContent = 'CPF';
                inputCnpj.placeholder = '000.000.000-00';
            }
        });
    }
});

// ==================== CONTATOS ====================
function abrirModalContato(index = -1) {
    editandoContatoIndex = index;
    const modal = document.getElementById('modalContato');
    const title = document.getElementById('modalContatoTitle');
    
    if (index >= 0) {
        title.textContent = 'Editar Contato';
        const contato = contatos[index];
        document.getElementById('contatoNome').value = contato.nome || '';
        document.getElementById('contatoCargo').value = contato.cargo || '';
        document.getElementById('contatoTelefone').value = contato.telefone || '';
        document.getElementById('contatoEmail').value = contato.email || '';
        document.getElementById('contatoObservacoes').value = contato.observacoes || '';
    } else {
        title.textContent = 'Adicionar Contato';
        document.getElementById('formContato').reset();
    }
    
    modal.classList.remove('hidden');
    document.getElementById('contatoNome').focus();
}

function fecharModalContato() {
    document.getElementById('modalContato').classList.add('hidden');
    document.getElementById('formContato').reset();
    editandoContatoIndex = -1;
}

function salvarContato(event) {
    event.preventDefault();
    
    const contato = {
        nome: document.getElementById('contatoNome').value,
        cargo: document.getElementById('contatoCargo').value,
        telefone: document.getElementById('contatoTelefone').value,
        email: document.getElementById('contatoEmail').value,
        observacoes: document.getElementById('contatoObservacoes').value
    };
    
    if (editandoContatoIndex >= 0) {
        // Editando contato existente
        contatos[editandoContatoIndex] = contato;
    } else {
        // Adicionando novo contato
        {% if cliente %}
        // Se está editando um cliente, salvar no servidor imediatamente
        fetch(`/clientes/{{ cliente.id }}/contato/adicionar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(contato)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                contato.id = data.id; // Adiciona o ID retornado
                contatos.push(contato);
                renderContatos();
            } else {
                alert('Erro ao adicionar contato: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao adicionar contato');
        });
        {% else %}
        // Cliente novo, apenas adiciona ao array
        contatos.push(contato);
        {% endif %}
    }
    
    renderContatos();
    fecharModalContato();
}

function editarContato(index) {
    abrirModalContato(index);
}

function removerContato(index) {
    window.modalConfirmacaoAction = {
        callback: async () => {
            const contato = contatos[index];
            
            // Se está editando um cliente existente e o contato tem ID, deletar no servidor
            {% if cliente %}
            if (contato.id) {
                try {
                    const response = await fetch(`/clientes/{{ cliente.id }}/contato/${contato.id}/deletar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        alert('Erro ao remover contato do servidor');
                        return;
                    }
                } catch (error) {
                    console.error('Erro ao deletar contato:', error);
                    alert('Erro ao remover contato');
                    return;
                }
            }
            {% endif %}
            
            // Remove do array local
            contatos.splice(index, 1);
            renderContatos();
        },
        tipo: 'contato',
        index: index
    };
    
    document.getElementById('tituloConfirmacao').textContent = 'Remover Contato';
    document.getElementById('mensagemConfirmacao').textContent = 'Deseja realmente remover este contato?';
    document.getElementById('modalConfirmacao').classList.remove('hidden');
}

function renderContatos() {
    const list = document.getElementById('contatos-list');
    list.innerHTML = '';
    
    if (contatos.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">Nenhum contato adicional cadastrado</p>';
    } else {
        contatos.forEach((contato, index) => {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-3 rounded border border-gray-200';
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold">${contato.nome}</div>
                        <div class="text-sm text-gray-600">
                            ${contato.cargo ? `<span class="mr-3"><i class="fas fa-briefcase mr-1"></i>${contato.cargo}</span>` : ''}
                            ${contato.telefone ? `<span class="mr-3"><i class="fas fa-phone mr-1"></i>${contato.telefone}</span>` : ''}
                            ${contato.email ? `<span><i class="fas fa-envelope mr-1"></i>${contato.email}</span>` : ''}
                        </div>
                        ${contato.observacoes ? `<div class="text-sm text-gray-500 mt-1">${contato.observacoes}</div>` : ''}
                    </div>
                    <div class="flex space-x-2 ml-3">
                        <button type="button" onclick="editarContato(${index})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="removerContato(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }
    
    document.getElementById('contatos_json').value = JSON.stringify(contatos);
}

// ==================== PRODUTOS ====================
function abrirModalProduto(index = -1) {
    editandoProdutoIndex = index;
    const modal = document.getElementById('modalProduto');
    const title = document.getElementById('modalProdutoTitle');
    
    if (index >= 0) {
        title.textContent = 'Editar Produto/Serviço';
        const produto = produtos[index];
        document.getElementById('produtoNome').value = produto.nome || '';
        document.getElementById('produtoCodigo').value = produto.codigo || '';
        document.getElementById('produtoDescricao').value = produto.descricao || '';
    } else {
        title.textContent = 'Adicionar Produto/Serviço';
        document.getElementById('formProduto').reset();
    }
    
    modal.classList.remove('hidden');
    document.getElementById('produtoNome').focus();
}

function fecharModalProduto() {
    document.getElementById('modalProduto').classList.add('hidden');
    document.getElementById('formProduto').reset();
    editandoProdutoIndex = -1;
}

function salvarProduto(event) {
    event.preventDefault();
    
    const produto = {
        nome: document.getElementById('produtoNome').value,
        codigo: document.getElementById('produtoCodigo').value,
        descricao: document.getElementById('produtoDescricao').value,
        is_active: true
    };
    
    if (editandoProdutoIndex >= 0) {
        // Editando produto existente
        produtos[editandoProdutoIndex] = produto;
    } else {
        // Adicionando novo produto
        {% if cliente %}
        // Se está editando um cliente, salvar no servidor imediatamente
        fetch(`/clientes/{{ cliente.id }}/produto/adicionar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(produto)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                produto.id = data.id; // Adiciona o ID retornado
                produtos.push(produto);
                renderProdutos();
            } else {
                alert('Erro ao adicionar produto: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao adicionar produto');
        });
        {% else %}
        // Cliente novo, apenas adiciona ao array
        produtos.push(produto);
        {% endif %}
    }
    
    renderProdutos();
    fecharModalProduto();
}

function editarProduto(index) {
    abrirModalProduto(index);
}

function removerProduto(index) {
    window.modalConfirmacaoAction = {
        callback: async () => {
            const produto = produtos[index];
            
            // Se está editando um cliente existente e o produto tem ID, deletar no servidor
            {% if cliente %}
            if (produto.id) {
                try {
                    const response = await fetch(`/clientes/{{ cliente.id }}/produto/${produto.id}/deletar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        alert('Erro ao remover produto do servidor');
                        return;
                    }
                } catch (error) {
                    console.error('Erro ao deletar produto:', error);
                    alert('Erro ao remover produto');
                    return;
                }
            }
            {% endif %}
            
            // Remove do array local
            produtos.splice(index, 1);
            renderProdutos();
        },
        tipo: 'produto',
        index: index
    };
    
    document.getElementById('tituloConfirmacao').textContent = 'Remover Produto';
    document.getElementById('mensagemConfirmacao').textContent = 'Deseja realmente remover este produto/serviço?';
    document.getElementById('modalConfirmacao').classList.remove('hidden');
}

function renderProdutos() {
    const list = document.getElementById('produtos-list');
    list.innerHTML = '';
    
    if (produtos.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">Nenhum produto/serviço cadastrado</p>';
    } else {
        produtos.forEach((produto, index) => {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-3 rounded border border-gray-200';
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold">${produto.nome}</div>
                        <div class="text-sm text-gray-600">
                            ${produto.codigo ? `<span class="bg-meetcall-purple text-white px-2 py-1 rounded text-xs mr-2">${produto.codigo}</span>` : ''}
                            ${produto.descricao ? `<span class="text-gray-500">${produto.descricao}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-3">
                        <button type="button" onclick="editarProduto(${index})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="removerProduto(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }
    
    document.getElementById('produtos_json').value = JSON.stringify(produtos);
}

function fecharModalConfirmacao() {
    document.getElementById('modalConfirmacao').classList.add('hidden');
    window.modalConfirmacaoAction = { callback: null, tipo: null, index: null };
}

function confirmarExclusao() {
    if (window.modalConfirmacaoAction.callback) {
        window.modalConfirmacaoAction.callback();
    }
    fecharModalConfirmacao();
}

// Aguardar DOM carregar para adicionar eventos aos modais
document.addEventListener('DOMContentLoaded', function() {
    // Fechar modais ao clicar fora
    const modalContato = document.getElementById('modalContato');
    if (modalContato) {
        modalContato.addEventListener('click', function(e) {
            if (e.target === this) fecharModalContato();
        });
    }

    const modalProduto = document.getElementById('modalProduto');
    if (modalProduto) {
        modalProduto.addEventListener('click', function(e) {
            if (e.target === this) fecharModalProduto();
        });
    }

    const modalConfirmacao = document.getElementById('modalConfirmacao');
    if (modalConfirmacao) {
        modalConfirmacao.addEventListener('click', function(e) {
            if (e.target === this) fecharModalConfirmacao();
        });
    }

    // Renderizar ao carregar
    renderContatos();
    renderProdutos();
});

// Validar formulário antes de enviar
function validarFormulario(event) {
    // Garantir que os campos hidden estão atualizados
    document.getElementById('contatos_json').value = JSON.stringify(contatos);
    document.getElementById('produtos_json').value = JSON.stringify(produtos);
    return true;
}
</script>
{% endblock %}
